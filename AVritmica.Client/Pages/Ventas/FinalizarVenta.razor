@page "/ventas/finalizar"
@using AVritmica.Shared.DTO
@using AVritmica.Client.Servicios.Entidades
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="container py-5">

    <!-- Título principal -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-violet-gradient mb-0">
            <i class="fas fa-lock me-2"></i> Finalizar compra
        </h2>

        <span class="badge bg-violet rounded-pill px-3 py-2">
            @itemsCarrito?.Sum(i => i.Cantidad) items
        </span>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border spinner-violet" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Preparando el resumen de tu compra...</p>
        </div>
    }
    else if (itemsCarrito is null || !itemsCarrito.Any())
    {
        <div class="alert alert-warning shadow-sm border-0 rounded-3">
            <i class="fas fa-info-circle me-2"></i>
            No hay productos en el carrito para finalizar la venta.
        </div>
    }
    else
    {
        @if (!string.IsNullOrWhiteSpace(errorMensaje))
        {
            <div class="alert alert-danger shadow-sm border-0 rounded-3">
                <i class="fas fa-exclamation-triangle me-2"></i> @errorMensaje
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(mensajeOk))
        {
            <div class="alert alert-success shadow-sm border-0 rounded-3">
                <i class="fas fa-check-circle me-2"></i> @mensajeOk
            </div>
        }

        <div class="row">
            <!-- Columna izquierda: resumen carrito -->
            <div class="col-lg-5 mb-4">
                <!-- RESUMEN DEL CARRITO -->
                <div class="card mb-4 border-violet shadow-sm checkout-card">
                    <div class="card-header bg-gradient-violet text-white">
                        <strong><i class="fas fa-shopping-cart me-2"></i> Resumen del carrito</strong>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table mb-0 align-middle">
                                <thead class="table-header-violet">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in itemsCarrito)
                                    {
                                        <tr>
                                            <td>
                                                <strong class="text-violet">@item.ProductoNombre</strong><br />
                                                @if (!string.IsNullOrEmpty(item.Color) || !string.IsNullOrEmpty(item.Tamaño))
                                                {
                                                    <small class="text-muted">
                                                        @if (!string.IsNullOrEmpty(item.Color))
                                                        {
                                                            <span><i class="fas fa-palette me-1"></i>@item.Color</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(item.Tamaño))
                                                        {
                                                            <span class="ms-2"><i class="fas fa-ruler me-1"></i>@item.Tamaño</span>
                                                        }
                                                    </small>
                                                }
                                            </td>
                                            <td class="text-center">@item.Cantidad</td>
                                            <td class="text-end">$@item.PrecioUnitario.ToString("N2")</td>
                                            <td class="text-end fw-semibold text-violet">
                                                $@((item.Cantidad * item.PrecioUnitario).ToString("N2"))
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th colspan="3" class="text-end">Subtotal</th>
                                        <th class="text-end">$@subtotal.ToString("N2")</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3" class="text-end">Costo de envío</th>
                                        <th class="text-end">$@venta.CostoEnvio.ToString("N2")</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3" class="text-end">Total</th>
                                        <th class="text-end h5 text-violet mb-0">$@total.ToString("N2")</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Nota seguridad -->
                <div class="card border-violet shadow-sm">
                    <div class="card-body small text-muted d-flex align-items-center">
                        <i class="fas fa-shield-alt me-2 text-violet"></i>
                        Tu compra se procesa de forma segura. Recibirás la confirmación final por WhatsApp.
                    </div>
                </div>
            </div>

            <!-- Columna derecha: formulario -->
            <div class="col-lg-7">
                <!-- FORMULARIO DATOS CLIENTE / ENVÍO / PAGO -->
                <EditForm EditContext="editContext" OnValidSubmit="ConfirmarVenta">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- DATOS DEL CLIENTE -->
                    <div class="card mb-4 border-violet shadow-sm checkout-card">
                        <div class="card-header bg-light-violet">
                            <strong><i class="fas fa-user me-2"></i> Datos del cliente</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Nombre y apellido *</label>
                                    <InputText @bind-Value="venta.NombreCliente" class="form-control" />
                                    <ValidationMessage For="@(() => venta.NombreCliente)" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Email *</label>
                                    <InputText @bind-Value="venta.Email" class="form-control" />
                                    <ValidationMessage For="@(() => venta.Email)" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Teléfono *</label>
                                    <InputText @bind-Value="venta.Telefono" class="form-control" />
                                    <ValidationMessage For="@(() => venta.Telefono)" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ENVÍO -->
                    <div class="card mb-4 border-violet shadow-sm checkout-card">
                        <div class="card-header bg-light-violet">
                            <strong><i class="fas fa-truck me-2"></i> Envío</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de envío *</label>
                                    <InputSelect @bind-Value="TipoEnvioSeleccionado" class="form-select">
                                        <option value="RetiroLocal">Retiro en el local</option>
                                        <option value="EnvioDomicilio">Envío a domicilio</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => venta.TipoEnvio)" />
                                </div>

                                @if (venta.TipoEnvio == "EnvioDomicilio")
                                {
                                    <div class="col-md-4">
                                        <label class="form-label">Dirección *</label>
                                        <InputText @bind-Value="venta.DireccionEnvio" class="form-control" />
                                        <ValidationMessage For="@(() => venta.DireccionEnvio)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Ciudad *</label>
                                        <InputText @bind-Value="venta.CiudadEnvio" class="form-control" />
                                        <ValidationMessage For="@(() => venta.CiudadEnvio)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Código postal *</label>
                                        <InputText @bind-Value="venta.CodigoPostalEnvio" class="form-control" />
                                        <ValidationMessage For="@(() => venta.CodigoPostalEnvio)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Provincia *</label>
                                        <InputText @bind-Value="venta.ProvinciaEnvio" class="form-control" />
                                        <ValidationMessage For="@(() => venta.ProvinciaEnvio)" />
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Costo de envío</label>
                                        <InputNumber @bind-Value="venta.CostoEnvio"
                                                     class="form-control"
                                                     disabled />
                                        <small class="text-muted">
                                            Costo fijo de envío a domicilio:
                                            $@COSTO_ENVIO_DOMICILIO.ToString("N2")
                                        </small>
                                        <ValidationMessage For="@(() => venta.CostoEnvio)" />
                                    </div>
                                }
                                else
                                {
                                    <div class="col-md-4">
                                        <label class="form-label">Costo de envío</label>
                                        <InputNumber @bind-Value="venta.CostoEnvio"
                                                     class="form-control"
                                                     readonly />
                                        <small class="text-muted">
                                            Para retiro en local, el costo de envío es $0.
                                        </small>
                                        <ValidationMessage For="@(() => venta.CostoEnvio)" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- PAGO -->
                    <div class="card mb-4 border-violet shadow-sm checkout-card">
                        <div class="card-header bg-light-violet">
                            <strong><i class="fas fa-credit-card me-2"></i> Pago</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Método de pago *</label>
                                    <InputSelect @bind-Value="venta.MetodoPago" class="form-select">
                                        <option value="">-- Seleccionar --</option>
                                        <option value="EfectivoLocal">Efectivo en el local</option>
                                        <option value="Transferencia">Transferencia bancaria</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => venta.MetodoPago)" />
                                </div>

                                @if (venta.MetodoPago == "Transferencia")
                                {
                                    <div class="col-md-4">
                                        <label class="form-label">Número de comprobante *</label>
                                        <InputText @bind-Value="venta.NumeroComprobante" class="form-control" />
                                        <ValidationMessage For="@(() => venta.NumeroComprobante)" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Banco de origen</label>
                                        <InputText @bind-Value="venta.BancoOrigen" class="form-control" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Titular de la cuenta</label>
                                        <InputText @bind-Value="venta.TitularCuenta" class="form-control" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Fecha de transferencia</label>
                                        <InputDate @bind-Value="venta.FechaTransferencia" class="form-control" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- OBSERVACIONES -->
                    <div class="card mb-4 border-violet shadow-sm checkout-card">
                        <div class="card-header bg-light-violet">
                            <strong><i class="fas fa-comment-dots me-2"></i> Observaciones</strong>
                        </div>
                        <div class="card-body">
                            <InputTextArea @bind-Value="venta.Notas" class="form-control" rows="3" />
                            <ValidationMessage For="@(() => venta.Notas)" />
                        </div>
                    </div>

                    <!-- BOTONES -->
                    <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
                        <button type="button"
                                class="btn btn-outline-violet"
                                @onclick="VolverAlCarrito">
                            <i class="fas fa-arrow-left me-2"></i> Volver al carrito
                        </button>

                        <button type="submit"
                                class="btn btn-violet-gradient btn-lg"
                                disabled="@procesando">
                            @if (procesando)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-2">Procesando...</span>
                            }
                            else
                            {
                                <span>
                                    <i class="fas fa-check me-2"></i> Confirmar compra
                                </span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>


@if (mostrarModalConfirmacion)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-rounded">
                <div class="modal-header bg-gradient-violet text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i> Compra realizada
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalConfirmacion"></button>
                </div>
                <div class="modal-body">
                    <p>La compra se registró correctamente en el sistema.</p>
                    <p>
                        <strong>Total de la compra:</strong>
                        <span class="text-violet fw-bold ms-1">$@total.ToString("N2")</span>
                    </p>

                    @if (venta.MetodoPago == "Transferencia")
                    {
                        <p class="mt-3">
                            Para <strong>finalizar</strong> la compra, debés enviar el
                            <strong>comprobante de la transferencia</strong> por WhatsApp al
                            <a href="@WhatsAppUrlTransferencia" target="_blank" class="fw-bold text-success">
                                @("+" + "54" + WhatsAppNumero)
                            </a>.
                            Una vez recibido el comprobante, desde la tiendanos comunicaremos contigo y confirmaremos el pago y el cierre de la compra exitosamente.
                        </p>
                    }
                    else if (venta.MetodoPago == "EfectivoLocal")
                    {
                        <p class="mt-3">
                            Para <strong>coordinar el pago en efectivo y el retiro/envío</strong>, comunicate por WhatsApp al
                            <a href="@WhatsAppUrlEfectivo" target="_blank" class="fw-bold text-success">
                                @("+" + "54" + WhatsAppNumero)
                            </a>.
                        </p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-violet" @onclick="IrAListaCarritos">
                        <i class="fas fa-shopping-bag me-2"></i> Aceptar
                    </button>
                    
                </div>
            </div>
        </div>
    </div>
}

@code {
    
    private const int usuarioIdTemporal = 1; // mismo criterio que en CarritoServicio
    private const decimal COSTO_ENVIO_DOMICILIO = 8000m;

    private List<CarritoItemDTO> itemsCarrito = new();
    private CrearVentaDTO venta = new();
    private decimal subtotal;
    private decimal total;
    private bool cargando = true;
    private bool procesando = false;
    private string? errorMensaje;
    private string? mensajeOk;
    private bool mostrarModalConfirmacion = false;

    private EditContext? editContext;

    // Wrapper para el select de tipo de envío
    private string tipoEnvioSeleccionado = "RetiroLocal";
    private string TipoEnvioSeleccionado
    {
        get => tipoEnvioSeleccionado;
        set
        {
            if (tipoEnvioSeleccionado == value) return;

            tipoEnvioSeleccionado = value;
            venta.TipoEnvio = value;
            AplicarCostoEnvio();
        }
    }

    // WhatsApp
    private const string WhatsAppNumero = "3512276627"; // CAMBIÁ SI HACE FALTA
    private string WhatsAppUrlTransferencia =>
        $"https://wa.me/54{WhatsAppNumero}?text=Hola%20AVritmica,%20te%20env%C3%ADo%20el%20comprobante%20de%20la%20transferencia%20de%20mi%20compra.";
    private string WhatsAppUrlEfectivo =>
        $"https://wa.me/54{WhatsAppNumero}?text=Hola%20AVritmica,%20quisiera%20coordinar%20el%20pago%20en%20efectivo%20y%20el%20retiro%20de%20mi%20compra.";

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosIniciales();

        editContext = new EditContext(venta);
        editContext.OnValidationRequested += OnValidationRequested;
    }

    private void OnValidationRequested(object? sender, ValidationRequestedEventArgs e)
    {
        venta.Detalles = itemsCarrito.Select(i => new CrearVentaDetalleDTO
        {
            ProductoId = i.ProductoId,
            Cantidad = i.Cantidad,
            PrecioUnitario = i.PrecioUnitario
        }).ToList();
    }

    private async Task CargarDatosIniciales()
    {
        cargando = true;
        errorMensaje = null;
        mensajeOk = null;

        try
        {
            var urlItems = $"api/Carritos/items?usuarioId={usuarioIdTemporal}";
            var response = await Http.GetAsync(urlItems);

            if (!response.IsSuccessStatusCode)
            {
                errorMensaje = $"Error al cargar el carrito ({response.StatusCode})";
                itemsCarrito = new();
            }
            else
            {
                var data = await response.Content.ReadFromJsonAsync<List<CarritoItemDTO>>();
                itemsCarrito = data ?? new();
            }

            subtotal = itemsCarrito.Sum(i => i.Cantidad * i.PrecioUnitario);

            venta = new CrearVentaDTO
            {
                TipoEnvio = "RetiroLocal",
                MetodoPago = "EfectivoLocal",
                CostoEnvio = 0,
                Subtotal = subtotal,
                Total = subtotal,
                Detalles = new List<CrearVentaDetalleDTO>()
            };

            tipoEnvioSeleccionado = venta.TipoEnvio;

            AplicarCostoEnvio();
        }
        catch (Exception ex)
        {
            errorMensaje = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void AplicarCostoEnvio()
    {
        if (venta.TipoEnvio == "EnvioDomicilio")
        {
            venta.CostoEnvio = COSTO_ENVIO_DOMICILIO;
        }
        else
        {
            venta.CostoEnvio = 0;
        }

        RecalcularTotales();
    }

    private void RecalcularTotales()
    {
        subtotal = itemsCarrito.Sum(i => i.Cantidad * i.PrecioUnitario);
        venta.Subtotal = subtotal;

        total = subtotal + venta.CostoEnvio;
        venta.Total = total;
    }

    private async Task ConfirmarVenta()
    {
        errorMensaje = null;
        mensajeOk = null;
        procesando = true;

        try
        {
            venta.Detalles = itemsCarrito.Select(i => new CrearVentaDetalleDTO
            {
                ProductoId = i.ProductoId,
                Cantidad = i.Cantidad,
                PrecioUnitario = i.PrecioUnitario
            }).ToList();

            RecalcularTotales();

            var response = await Http.PostAsJsonAsync("api/Ventas/crear-con-detalles", venta);

            if (!response.IsSuccessStatusCode)
            {
                var errorText = await response.Content.ReadAsStringAsync();
                errorMensaje = $"No se pudo registrar la venta: {errorText}";
                return;
            }

            mensajeOk = "La compra se registró correctamente en el sistema.";

            var respVaciar = await Http.DeleteAsync($"api/Carritos/vaciar?usuarioId={usuarioIdTemporal}");
            if (!respVaciar.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("console.warn", "No se pudo vaciar el carrito después de la venta.");
            }

            mostrarModalConfirmacion = true;
        }
        catch (Exception ex)
        {
            errorMensaje = $"Error al registrar la venta: {ex.Message}";
        }
        finally
        {
            procesando = false;
        }
    }

    private void VolverAlCarrito()
    {
        Navigation.NavigateTo("/carrito");
    }

    private void CerrarModalConfirmacion()
    {
        mostrarModalConfirmacion = false;
    }

    private void IrAProductos()
    {
        mostrarModalConfirmacion = false;
        Navigation.NavigateTo("/catalogo");
    }

    private void IrAListaCarritos()
    {
        mostrarModalConfirmacion = false;
        Navigation.NavigateTo("/carrito");
    }
}

<style>
    .text-violet-gradient {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .text-violet {
        color: #e753fe !important;
    }

    .bg-violet {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%) !important;
        color: #fff !important;
    }

    .bg-gradient-violet {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%) !important;
    }

    .bg-light-violet {
        background: linear-gradient(90deg, rgba(231, 83, 254, 0.08), rgba(69, 0, 80, 0.04)) !important;
    }

    .btn-violet-gradient {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%) !important;
        border: none !important;
        color: white !important;
        transition: all 0.3s ease;
    }

        .btn-violet-gradient:hover {
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.4) !important;
            transform: translateY(-2px);
        }

        .btn-violet-gradient:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    .btn-outline-violet {
        color: #e753fe !important;
        border-color: #e753fe !important;
        background: transparent !important;
        transition: all 0.3s ease;
    }

        .btn-outline-violet:hover {
            background: linear-gradient(180deg, rgba(69, 0, 80, 0.08) 0%, rgba(231, 83, 254, 0.12) 100%) !important;
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.25) !important;
        }

    .border-violet {
        border-color: rgba(231, 83, 254, 0.4) !important;
    }

    .spinner-violet {
        color: #e753fe;
        width: 3rem;
        height: 3rem;
    }

    .table-header-violet th {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%);
        color: white;
        border-color: transparent;
        font-weight: 500;
    }

    .checkout-card {
        border-radius: 18px;
    }

    .modal-rounded {
        border-radius: 18px;
        overflow: hidden;
    }

    @@media (max-width: 768px) {
        .checkout-card

    {
        margin-bottom: 1.25rem;
    }

    }
</style>
