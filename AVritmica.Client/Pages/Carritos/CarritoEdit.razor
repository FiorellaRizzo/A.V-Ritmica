@page "/carritos/editar/{id:int}"
@page "/carritos/nuevo"

@using AVritmica.Shared.DTO
@using System.Linq

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>@Titulo</h3>


<EditForm Model="carritoDTO" OnValidSubmit="GuardarCarrito">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Usuario *</label>
                <InputSelect class="form-select" @bind-Value="carritoDTO.UsuarioId">
                    <option value="0">Seleccione un usuario</option>
                    @foreach (var usuario in usuarios)
                    {
                        <option value="@usuario.Id">@usuario.Nombre @usuario.Apellido - @usuario.Email</option>
                    }
                </InputSelect>
                @if (carritoDTO.UsuarioId == 0)
                {
                    <div class="text-danger">Debe seleccionar un usuario</div>
                }
            </div>

            <div class="mb-3">
                <label class="form-label">Estado</label>
                <InputSelect class="form-select" @bind-Value="carritoDTO.Estado">
                    <option value="Activo">Activo</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Cancelado">Cancelado</option>
                    <option value="Completado">Completado</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">Estado de Pago</label>
                <InputSelect class="form-select" @bind-Value="carritoDTO.EstadoPago">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Pagado">Pagado</option>
                    <option value="Parcial">Parcial</option>
                    <option value="Cancelado">Cancelado</option>
                </InputSelect>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Monto Total</label>
                <InputNumber class="form-control" @bind-Value="carritoDTO.MontoTotal" />
            </div>

            <div class="mb-3">
                <label class="form-label">Saldo</label>
                <InputNumber class="form-control" @bind-Value="carritoDTO.Saldo" />
            </div>

            <div class="mb-3">
                <label class="form-label">Dirección de Envío</label>
                <InputTextArea class="form-control" @bind-Value="carritoDTO.DireccionEnvio" />
            </div>
        </div>
    </div>

   
    <div class="mt-3">
        <button type="submit" class="btn btn-primary" disabled="@guardando">@BotonGuardarTexto</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>


@if (EsEdicion && carritoDTO.Estado == "Activo")
{
    <hr />
    <h4>Agregar producto a este carrito</h4>

    <EditForm Model="nuevoItem" OnValidSubmit="AgregarItem">
        <DataAnnotationsValidator />

        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Producto *</label>
                <InputSelect class="form-select" @bind-Value="ProductoSeleccionadoId">
                    <option value="0">Seleccione un producto</option>
                    @foreach (var p in productos)
                    {
                        <option value="@p.Id">@p.Nombre - $@p.Precio.ToString("N2")</option>
                    }
                </InputSelect>
                @if (ProductoSeleccionadoId == 0)
                {
                    <div class="text-danger">Debe seleccionar un producto</div>
                }
            </div>

            <div class="col-md-3">
                <label class="form-label">Cantidad *</label>
                <InputNumber class="form-control" @bind-Value="nuevoItem.Cantidad" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Precio Unitario *</label>
                <InputNumber class="form-control"
                             @bind-Value="nuevoItem.PrecioUnitario" />
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-success btn-sm">Agregar producto</button>
        </div>
    </EditForm>
}
else if (EsEdicion)
{
    <p class="text-muted mt-2">
        Solo se pueden agregar productos cuando el carrito está en estado <strong>Activo</strong>.
    </p>
}

@code {
    [Parameter] public int Id { get; set; }

    private CarritoDTO carritoDTO = new();
    private List<Usuario> usuarios = new();
    private List<Producto> productos = new();

    
    private CrearCarritoProductoDTO nuevoItem = new() { Cantidad = 1 };

    private bool guardando = false;
    private bool EsEdicion => Id > 0;

    private string Titulo => EsEdicion ? "Editar Carrito" : "Nuevo Carrito";
    private string BotonGuardarTexto => guardando ? "Guardando..." : "Guardar";

    // Propiedad intermedia para el combo de productos
    private int ProductoSeleccionadoId
    {
        get => nuevoItem.ProductoId;
        set
        {
            nuevoItem.ProductoId = value;

            var producto = productos.FirstOrDefault(p => p.Id == value);
            if (producto != null)
            {
                
                nuevoItem.PrecioUnitario = producto.Precio;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
        await CargarProductos();

        if (EsEdicion)
        {
            await CargarCarrito();
        }
        else
        {
            carritoDTO.Estado = "Activo";
            carritoDTO.EstadoPago = "Pendiente";
            carritoDTO.FechaCreacion = DateTime.UtcNow;
        }
    }

    private async Task CargarUsuarios()
    {
        try
        {
            usuarios = await Http.GetFromJsonAsync<List<Usuario>>("api/Usuarios") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar usuarios: {ex.Message}");
        }
    }

    private async Task CargarProductos()
    {
        try
        {
            productos = await Http.GetFromJsonAsync<List<Producto>>("api/Productos") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar productos: {ex.Message}");
        }
    }

    private async Task CargarCarrito()
    {
        try
        {
            var carrito = await Http.GetFromJsonAsync<Carrito>($"api/Carritos/{Id}");
            if (carrito != null)
            {
                carritoDTO = new CarritoDTO
                {
                    Id = carrito.Id,
                    UsuarioId = carrito.UsuarioId,
                    Estado = carrito.Estado,
                    EstadoPago = carrito.EstadoPago,
                    MontoTotal = carrito.MontoTotal,
                    Saldo = carrito.Saldo,
                    DireccionEnvio = carrito.DireccionEnvio,
                    FechaCreacion = carrito.FechaCreacion,
                    FechaConfirmacion = carrito.FechaConfirmacion
                };
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar carrito: {ex.Message}");
        }
    }

    private async Task GuardarCarrito()
    {
        if (carritoDTO.UsuarioId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Por favor seleccione un usuario");
            return;
        }

        guardando = true;
        StateHasChanged();

        try
        {
            HttpResponseMessage response;

            if (EsEdicion)
            {
                carritoDTO.Id = Id;
                response = await Http.PutAsJsonAsync($"api/Carritos/actualizar/{Id}", carritoDTO);
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/Carritos/crear", carritoDTO);
            }

            if (response.IsSuccessStatusCode)
            {
                var msg = EsEdicion ? "Carrito actualizado correctamente" : "Carrito creado correctamente";
                await JS.InvokeVoidAsync("alert", msg);
                Navigation.NavigateTo("/carritos");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private async Task AgregarItem()
    {
        if (carritoDTO.Id == 0)
        {
            await JS.InvokeVoidAsync("alert", "Primero debe guardar el carrito.");
            return;
        }

        if (nuevoItem.ProductoId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Debe seleccionar un producto.");
            return;
        }

        try
        {
            nuevoItem.CarritoId = carritoDTO.Id;

            var response = await Http.PostAsJsonAsync("api/CarritoProductos/crear", nuevoItem);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Producto agregado al carrito.");
               
                Navigation.NavigateTo("/carritos");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error al agregar producto: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al agregar producto: {ex.Message}");
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/carritos");
    }
}
