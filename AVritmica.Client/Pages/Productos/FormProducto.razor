@page "/productos/nuevo"
@page "/productos/editar/{Id:int}"
@using AVritmica.Shared.DTO
@using AVritmica.BD.Data.Entity
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject NavigationManager Navigation

<h3>@Titulo</h3>

<EditForm Model="producto" OnValidSubmit="GuardarProducto">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- Campos básicos -->
    <div class="mb-3">
        <label class="form-label">Nombre *</label>
        <InputText @bind-Value="producto.Nombre" class="form-control" />
        <ValidationMessage For="@(() => producto.Nombre)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Descripción</label>
        <InputTextArea @bind-Value="producto.Descripcion" class="form-control" rows="3" />
        <ValidationMessage For="@(() => producto.Descripcion)" />
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Precio *</label>
            <InputNumber @bind-Value="producto.Precio" class="form-control" />
            <ValidationMessage For="@(() => producto.Precio)" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Stock Total *</label>
            <InputNumber @bind-Value="producto.Stock" class="form-control" />
            <ValidationMessage For="@(() => producto.Stock)" />
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">URL de Imagen Principal</label>
        <InputText @bind-Value="producto.ImagenUrl" class="form-control" />
        <ValidationMessage For="@(() => producto.ImagenUrl)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Categoría *</label>
        <InputSelect @bind-Value="producto.CategoriaId" class="form-control">
            <option value="">Seleccione una categoría</option>
            @foreach (var categoria in categorias)
            {
                <option value="@categoria.Id">@categoria.Nombre</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => producto.CategoriaId)" />
    </div>

    <!-- ============================================= -->
    <!-- SECCIÓN DE VARIANTES -->
    <!-- ============================================= -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-palette me-2"></i>Opciones y Variantes
            </h5>
        </div>
        <div class="card-body">
            <!-- Switch para activar variantes -->
            <div class="form-check form-switch mb-4">
                <InputCheckbox @bind-Value="producto.TieneVariantes" class="form-check-input" id="toggleVariantes" />
                <label class="form-check-label fw-bold" for="toggleVariantes" style="color: #450050; font-size: 1.1rem;">
                    Este producto tiene diferentes colores, tamaños o variantes
                </label>
            </div>

            <!-- Campos que SOLO aparecen si TieneVariantes es TRUE -->
            @if (producto.TieneVariantes)
            {
                <div class="variantes-section p-3 border rounded" style="background-color: #f8f9fa;">
                    <h6 class="mb-3" style="color: #450050;">
                        <i class="fas fa-cogs me-2"></i>Configurar Variantes
                    </h6>

                    <!-- Colores disponibles -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-palette me-1 text-primary"></i>Colores disponibles
                        </label>
                        <InputTextArea @bind-Value="producto.ColoresDisponibles"
                                       class="form-control"
                                       rows="2"
                                       placeholder="Ej: Rojo, Azul, Verde, Rosa, Dorado"
                                       @oninput="RecalcularStockPorColor" />
                        <small class="text-muted">Separar cada color con una coma. Ejemplo: "Rojo, Azul, Verde"</small>
                    </div>

                    <!-- Tamaños disponibles -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-expand-alt me-1 text-primary"></i>Tamaños disponibles
                        </label>
                        <InputTextArea @bind-Value="producto.TamaniosDisponibles"
                                       class="form-control"
                                       rows="2"
                                       placeholder="Ej: S, M, L, XL o 18cm, 19cm, 20cm" />
                        <small class="text-muted">Separar cada tamaño con una coma. Ejemplo: "S, M, L"</small>
                    </div>

                    <!-- Imágenes de variantes -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-images me-1 text-primary"></i>Imágenes para cada variante
                        </label>
                        <InputTextArea @bind-Value="producto.ImagenesVariantes"
                                       class="form-control"
                                       rows="3"
                                       placeholder="https://ejemplo.com/imagen-rojo.jpg, https://ejemplo.com/imagen-azul.jpg" />
                        <small class="text-muted">URLs de imágenes separadas por comas. Una por cada variante.</small>
                    </div>

                    <!-- Resumen de lo configurado -->
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-info-circle me-2"></i>Resumen de variantes configuradas:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Colores:</strong><br>
                                @if (!string.IsNullOrEmpty(producto.ColoresDisponibles))
                                {
                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        @foreach (var color in producto.ColoresDisponibles.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                        {
                                            <span class="badge bg-primary">@color.Trim()</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">No definidos</span>
                                }
                            </div>
                            <div class="col-md-6">
                                <strong>Tamaños:</strong><br>
                                @if (!string.IsNullOrEmpty(producto.TamaniosDisponibles))
                                {
                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        @foreach (var tam in producto.TamaniosDisponibles.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                        {
                                            <span class="badge bg-secondary">@tam.Trim()</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">No definidos</span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- ============================================= -->
                    <!-- NUEVA SECCIÓN: STOCK POR COLOR -->
                    <!-- ============================================= -->
                    @if (!string.IsNullOrEmpty(producto.ColoresDisponibles))
                    {
                        <div class="card mt-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-boxes me-2"></i>Gestión de Stock por Color
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Importante:</strong> Aquí defines cuántas unidades hay de cada color.
                                    El stock total del producto será la suma de todos los colores.
                                </div>

                                @{
                                    var coloresLista = producto.ColoresDisponibles
                                    .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                    .Select(c => c.Trim())
                                    .ToList();
                                }

                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Color</th>
                                                <th>Stock Disponible</th>
                                                <th>Estado</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var color in coloresLista)
                                            {
                                                var stockActual = stockPorColorDic.ContainsKey(color) ? stockPorColorDic[color] : 0;
                                                var estaAgotado = stockActual <= 0;

                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="color-circle me-2" style="background-color: @ObtenerColorHex(color)"></div>
                                                            <strong>@color</strong>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="number"
                                                               class="form-control form-control-sm"
                                                               value="@stockActual"
                                                               @onchange="@(e => ActualizarStockColor(color, e))"
                                                               min="0"
                                                               style="width: 100px; display: inline-block;" />
                                                    </td>
                                                    <td>
                                                        @if (estaAgotado)
                                                        {
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-times-circle me-1"></i>AGOTADO
                                                            </span>
                                                        }
                                                        else if (stockActual < 5)
                                                        {
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="fas fa-exclamation-triangle me-1"></i>ÚLTIMAS (@stockActual)
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-success">
                                                                <i class="fas fa-check-circle me-1"></i>DISPONIBLE (@stockActual)
                                                            </span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <button type="button"
                                                                class="btn btn-outline-danger btn-sm"
                                                                @onclick="() => PonerEnCero(color)"
                                                                title="Poner en 0 (agotado)">
                                                            <i class="fas fa-ban"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <td><strong>TOTAL</strong></td>
                                                <td>
                                                    <input type="number"
                                                           @bind="producto.Stock"
                                                           class="form-control form-control-sm"
                                                           style="width: 100px; display: inline-block;"
                                                           min="0" />
                                                </td>
                                                <td colspan="2">
                                                    <small class="text-muted">
                                                        Stock total: @producto.Stock unidades
                                                    </small>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Botones de ayuda -->
                                <div class="d-flex gap-2 mt-3">
                                  
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            @onclick="CalcularTotalStock">
                                        <i class="fas fa-calculator me-1"></i>Calcular Total desde Colores
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-light">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>¿Tu producto tiene opciones?</strong><br>
                    Si activas esta opción, los clientes podrán seleccionar entre diferentes colores,
                    tamaños o versiones de este producto al realizar su compra.
                </div>
            }
        </div>
    </div>

    <!-- Botones -->
    <div class="mt-4">
        <button type="submit" class="btn btn-primary" disabled="@cargando">
            @if (cargando)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            else
            {
                <i class="fas fa-save me-2"></i>
                @(Id == 0 ? "Crear Producto" : "Actualizar Producto")
            }
        </button>
        <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar" disabled="@cargando">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger mt-3">
        <i class="fas fa-exclamation-triangle me-2"></i>@mensajeError
    </div>
}

@if (!string.IsNullOrEmpty(mensajeExito))
{
    <div class="alert alert-success mt-3">
        <i class="fas fa-check-circle me-2"></i>@mensajeExito
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private CrearProductoDTO producto = new();
    private List<Categoria> categorias = new();
    private bool cargando = false;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string Titulo => Id == 0 ? "Nuevo Producto" : "Editar Producto";

    // NUEVAS VARIABLES PARA STOCK POR COLOR
    private Dictionary<string, int> stockPorColorDic = new Dictionary<string, int>();
    private Producto? productoExistente = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarCategorias();

        if (Id > 0)
        {
            await CargarProducto();
        }
        else
        {
            // Valores por defecto para nuevo producto
            producto.Stock = 0;
            producto.Precio = 0;
            producto.TieneVariantes = false;
            producto.ColoresDisponibles = "";
            producto.TamaniosDisponibles = "";
            producto.ImagenesVariantes = "";
            producto.StockPorColor = "";
        }
    }

    private async Task CargarCategorias()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await CategoriaService.GetCategorias();
            if (!respuesta.Error)
            {
                categorias = respuesta.Respuesta ?? new List<Categoria>();
            }
            else
            {
                mensajeError = "Error al cargar las categorías";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task CargarProducto()
    {
        cargando = true;
        mensajeError = string.Empty;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProducto(Id);
            if (!respuesta.Error && respuesta.Respuesta != null)
            {
                productoExistente = respuesta.Respuesta;

                // Cargar datos básicos
                producto = new CrearProductoDTO
                {
                    Nombre = productoExistente.Nombre,
                    Descripcion = productoExistente.Descripcion,
                    Precio = productoExistente.Precio,
                    Stock = productoExistente.Stock,
                    ImagenUrl = productoExistente.ImagenUrl,
                    CategoriaId = productoExistente.CategoriaId,
                    TieneVariantes = productoExistente.TieneVariantes,
                    ColoresDisponibles = productoExistente.ColoresDisponibles ?? "",
                    TamaniosDisponibles = productoExistente.TamaniosDisponibles ?? "",
                    ImagenesVariantes = productoExistente.ImagenesVariantes ?? "",
                    StockPorColor = productoExistente.StockPorColor ?? ""
                };

                // Cargar stock por color en el diccionario
                if (productoExistente.TieneVariantes && !string.IsNullOrEmpty(productoExistente.ColoresDisponibles))
                {
                    InicializarStockPorColorDic();
                }
            }
            else
            {
                mensajeError = await respuesta.ObtenerError();
                if (string.IsNullOrEmpty(mensajeError))
                {
                    mensajeError = "Error al cargar el producto";
                }
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }

        cargando = false;
        StateHasChanged();
    }

    // ========== MÉTODOS CORREGIDOS PARA STOCK POR COLOR ==========

    private void InicializarStockPorColorDic()
    {
        stockPorColorDic.Clear();

        // PRIMERO: Intentar cargar desde el string StockPorColor existente
        if (!string.IsNullOrEmpty(producto.StockPorColor))
        {
            var items = producto.StockPorColor.Split(';', StringSplitOptions.RemoveEmptyEntries);
            foreach (var item in items)
            {
                var partes = item.Split(':');
                if (partes.Length == 2 && int.TryParse(partes[1].Trim(), out int stock))
                {
                    stockPorColorDic[partes[0].Trim()] = stock;
                }
            }
        }

        // SEGUNDO: Si no hay datos en el string, pero hay colores configurados, distribuir equitativamente
        if (stockPorColorDic.Count == 0 && !string.IsNullOrEmpty(producto.ColoresDisponibles))
        {
            var colores = producto.ColoresDisponibles
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(c => c.Trim())
                .ToList();

            if (colores.Count > 0)
            {
                int stockPorColor = producto.Stock > 0 ? producto.Stock / colores.Count : 0;
                foreach (var color in colores)
                {
                    stockPorColorDic[color] = stockPorColor;
                }
            }
        }
    }

    private void RecalcularStockPorColor()
    {
        // Guardar los valores existentes para colores que ya tenían stock
        var valoresExistentes = new Dictionary<string, int>(stockPorColorDic);

        // Limpiar diccionario
        stockPorColorDic.Clear();

        // Recargar colores disponibles
        if (!string.IsNullOrEmpty(producto.ColoresDisponibles))
        {
            var nuevosColores = producto.ColoresDisponibles
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(c => c.Trim())
                .ToList();

            // Inicializar nuevos colores
            foreach (var color in nuevosColores)
            {
                // Si el color ya existía, mantener su valor
                if (valoresExistentes.ContainsKey(color))
                {
                    stockPorColorDic[color] = valoresExistentes[color];
                }
                else
                {
                    // Nuevo color: asignar valor por defecto
                    int stockPorColor = producto.Stock > 0 && nuevosColores.Count > 0 ?
                                       producto.Stock / nuevosColores.Count : 0;
                    stockPorColorDic[color] = stockPorColor;
                }
            }

            // Recalcular stock total
            CalcularTotalStock();
        }

        StateHasChanged();
    }

    private string ObtenerColorHex(string colorNombre)
    {
        var colores = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            {"Rojo", "#dc3545"}, {"Azul", "#0d6efd"}, {"Verde", "#198754"},
            {"Amarillo", "#ffc107"}, {"Naranja", "#fd7e14"}, {"Rosa", "#d63384"},
            {"Morado", "#6f42c1"}, {"Negro", "#000000"}, {"Blanco", "#ffffff"},
            {"Gris", "#6c757d"}, {"Dorado", "#ffd700"}, {"Plateado", "#c0c0c0"},
            {"Celeste", "#0dcaf0"}, {"Violeta", "#6f42c1"}, {"Marron", "#8b4513"},
            {"Lila", "#c8a2c8"}, {"Turquesa", "#40e0d0"}, {"Beige", "#f5f5dc"},
            {"Bordo", "#800000"}, {"Mostaza", "#ffdb58"}
        };

        return colores.ContainsKey(colorNombre) ? colores[colorNombre] : "#6c757d";
    }

    private void ActualizarStockColor(string color, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int nuevoStock))
        {
            stockPorColorDic[color] = nuevoStock;
            CalcularTotalStock();
            StateHasChanged();
        }
    }

    private void PonerEnCero(string color)
    {
        stockPorColorDic[color] = 0;
        CalcularTotalStock();
        StateHasChanged();
    }

    private void DistribuirEquitativamente()
    {
        if (!string.IsNullOrEmpty(producto.ColoresDisponibles) && producto.Stock > 0)
        {
            var colores = producto.ColoresDisponibles
                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(c => c.Trim())
                .ToList();

            if (colores.Count > 0)
            {
                int stockPorColor = producto.Stock / colores.Count;

                foreach (var color in colores)
                {
                    stockPorColorDic[color] = stockPorColor;
                }

                StateHasChanged();
            }
        }
    }

    private void CalcularTotalStock()
    {
        producto.Stock = stockPorColorDic.Values.Sum();
        StateHasChanged();
    }

    // Método para convertir diccionario a string StockPorColor
    private string ConvertirDiccionarioAStockPorColor()
    {
        if (stockPorColorDic.Count == 0) return "";
        return string.Join(";", stockPorColorDic.Select(kv => $"{kv.Key}:{kv.Value}"));
    }

    private async Task GuardarProducto()
    {
        cargando = true;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
        StateHasChanged();

        try
        {
            // DEBUG: Mostrar datos antes de guardar
            Console.WriteLine("=== DEBUG STOCK POR COLOR ===");
            Console.WriteLine($"String original: {producto.StockPorColor}");
            Console.WriteLine($"Diccionario: {string.Join(", ", stockPorColorDic.Select(kv => $"{kv.Key}:{kv.Value}"))}");

            // Convertir el diccionario a string para StockPorColor
            producto.StockPorColor = ConvertirDiccionarioAStockPorColor();

            Console.WriteLine($"String convertido: {producto.StockPorColor}");
            Console.WriteLine($"Stock total: {producto.Stock}");
            Console.WriteLine("==============================");

            if (Id == 0)
            {
                // Crear nuevo producto
                var respuesta = await ProductoService.CreateProducto(producto);
                if (!respuesta.Error)
                {
                    mensajeExito = "✅ Producto creado exitosamente";
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/productos");
                }
                else
                {
                    mensajeError = await respuesta.ObtenerError();
                    if (string.IsNullOrEmpty(mensajeError))
                    {
                        mensajeError = "Error al crear el producto";
                    }
                }
            }
            else
            {
                // Actualizar producto existente
                var productoActualizado = new Producto
                {
                    Id = Id,
                    Nombre = producto.Nombre,
                    Descripcion = producto.Descripcion,
                    Precio = producto.Precio,
                    Stock = producto.Stock,
                    ImagenUrl = producto.ImagenUrl,
                    CategoriaId = producto.CategoriaId,
                    TieneVariantes = producto.TieneVariantes,
                    ColoresDisponibles = producto.ColoresDisponibles,
                    TamaniosDisponibles = producto.TamaniosDisponibles,
                    ImagenesVariantes = producto.ImagenesVariantes,
                    StockPorColor = producto.StockPorColor
                };

                var respuesta = await ProductoService.UpdateProducto(Id, productoActualizado);
                if (!respuesta.Error)
                {
                    mensajeExito = "✅ Producto actualizado exitosamente";
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/productos");
                }
                else
                {
                    mensajeError = await respuesta.ObtenerError();
                    if (string.IsNullOrEmpty(mensajeError))
                    {
                        mensajeError = "Error al actualizar el producto";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
            Console.WriteLine($"❌ ERROR: {ex.Message}");
            Console.WriteLine($"❌ StackTrace: {ex.StackTrace}");
        }

        cargando = false;
        StateHasChanged();
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/productos");
    }
}

<style>
    /* Estilo para el switch */
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Animación suave para mostrar/ocultar variantes */
    .variantes-section {
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilo para los badges de colores y tamaños */
    .badge.bg-primary, .badge.bg-secondary {
        font-size: 0.8rem;
        padding: 4px 8px;
    }

    /* Círculos de color */
    .color-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #dee2e6;
        display: inline-block;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Mejorar la tabla */
    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
</style>