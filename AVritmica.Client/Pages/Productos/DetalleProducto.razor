@page "/producto/detalle/{ProductoId:int}"
@using AVritmica.BD.Data.Entity
@using AVritmica.Client.Servicios
@using AVritmica.Client.Servicios.Entidades
@using AVritmica.Shared.DTO
@inject IProductoService ProductoService
@inject ICarritoServicio CarritoServicio
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISesionUsuarioServicio SesionUsuarioServicio

<PageTitle>Avítmica - Detalle del Producto</PageTitle>

<!-- Breadcrumb con botón del carrito -->
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb" style="flex: 1;">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="/catalogo" class="text-decoration-none" style="color: #e753fe;">
                        <i class="fas fa-arrow-left me-1"></i>Volver al Catálogo
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Detalle del Producto</li>
            </ol>
        </nav>

        <!-- Botón del Carrito -->
        <div class="ms-3">
            <a class="btn position-relative px-3 py-1 d-flex align-items-center"
               href="/carrito"
               title="Ver carrito"
               style="background: rgba(69, 0, 80, 0.9);
                      color: white;
                      border: 1px solid rgba(231, 83, 254, 0.5);
                      border-radius: 6px;
                      font-weight: 600;
                      text-decoration: none;
                      box-shadow: 0 4px 12px rgba(69, 0, 80, 0.3);
                      font-size: 0.9rem;
                      white-space: nowrap;">

                <i class="fas fa-shopping-cart me-1"></i>
                <span>Carrito</span>

                @if (cantidadEnCarrito > 0)
                {
                    <span class="ms-1 badge rounded-pill px-1 py-0"
                          style="background: linear-gradient(180deg, #ff4757 0%, #ff3838 100%);
                                     color: white;
                                     font-size: 0.7rem;
                                     min-width: 18px;
                                     border: 1px solid white;">
                        @cantidadEnCarrito
                    </span>
                }
            </a>
        </div>
    </div>
</div>

@if (cargando)
{
    <div class="container text-center py-5">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #e753fe;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3" style="color: #450050;">Cargando información del producto...</p>
    </div>
}
else if (producto == null)
{
    <div class="container">
        <div class="alert alert-danger text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>Producto no encontrado</h4>
            <p>El producto que buscas no existe o ha sido eliminado.</p>
            <a href="/catalogo" class="btn mt-2">
                <i class="fas fa-store me-1"></i>Volver al Catálogo
            </a>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="row">
            <!-- Columna de Imagen -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="text-center">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl"
                                     class="img-fluid rounded"
                                     style="max-height: 400px; object-fit: contain;"
                                     alt="@producto.Nombre"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/500x400/450050/ffffff?text=Producto'">
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center" style="height: 400px; background: linear-gradient(180deg, rgba(231, 83, 254, 0.05) 0%, rgba(69, 0, 80, 0.05) 100%);">
                                    <i class="fas fa-ribbon fa-7x" style="color: #e753fe; opacity: 0.3;"></i>
                                </div>
                            }
                        </div>

                        <!-- Galería de variantes -->
                        @if (imagenesVariantes.Any())
                        {
                            <div class="mt-4">
                                <h6 style="color: #450050;">Otras variantes:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var img in imagenesVariantes)
                                    {
                                        <div class="border rounded p-1"
                                             style="cursor: pointer; width: 60px; height: 60px;"
                                             @onclick="() => CambiarImagenVariante(img)">
                                            <img src="@img"
                                                 class="w-100 h-100"
                                                 style="object-fit: cover;"
                                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60/450050/ffffff'">
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Columna de Información -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <!-- Mensajes de estado -->
                        @if (mensajeError != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i>@mensajeError
                                <button type="button" class="btn-close" @onclick="() => mensajeError = null"></button>
                            </div>
                        }

                        @if (mensajeExito != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                                <i class="fas fa-check-circle me-2"></i>@mensajeExito
                                <button type="button" class="btn-close" @onclick="() => mensajeExito = null"></button>
                            </div>
                        }

                        <!-- Estado del stock (según color seleccionado si hay variantes) -->
                        <div class="mb-3">
                            @if (producto.CompletamenteAgotado)
                            {
                                <span class="badge rounded-pill p-2"
                                      style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%); color:#fff;">
                                    <i class="fas fa-times-circle me-1"></i>COMPLETAMENTE AGOTADO
                                </span>
                                <small class="text-muted ms-2">
                                    <i class="fas fa-cube me-1"></i>No disponible en ningún color
                                </small>
                            }
                            else if (producto.TieneVariantes && !string.IsNullOrEmpty(colorSeleccionado))
                            {
                                var stockColorSeleccionado = producto.ObtenerStockPorColor(colorSeleccionado);

                                if (stockColorSeleccionado <= 0)
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%); color:#fff;">
                                        <i class="fas fa-times-circle me-1"></i>AGOTADO
                                    </span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-cube me-1"></i>Color @colorSeleccionado sin stock
                                    </small>
                                }
                                else if (stockColorSeleccionado < 5)
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #ffc107 0%, #fd7e14 100%); color:#212529;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>STOCK LIMITADO
                                    </span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-cube me-1"></i>Color @colorSeleccionado – quedan @stockColorSeleccionado u.
                                    </small>
                                }
                                else
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #28a745 0%, #20c997 100%); color:#fff;">
                                        <i class="fas fa-check-circle me-1"></i>DISPONIBLE
                                    </span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-cube me-1"></i>Color @colorSeleccionado – @stockColorSeleccionado u. disponibles
                                    </small>
                                }
                            }
                            else
                            {
                                // Producto sin variantes (o sin color seleccionado)
                                if (producto.Stock <= 0)
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%); color:#fff;">
                                        <i class="fas fa-times-circle me-1"></i>AGOTADO
                                    </span>
                                }
                                else if (producto.Stock < 5)
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #ffc107 0%, #fd7e14 100%); color:#212529;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>STOCK LIMITADO
                                    </span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-cube me-1"></i>Solo @producto.Stock u. disponibles
                                    </small>
                                }
                                else
                                {
                                    <span class="badge rounded-pill p-2"
                                          style="background: linear-gradient(180deg, #28a745 0%, #20c997 100%); color:#fff;">
                                        <i class="fas fa-check-circle me-1"></i>DISPONIBLE
                                    </span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-cube me-1"></i>@producto.Stock unidades totales
                                    </small>
                                }
                            }
                        </div>


                        <!-- Nombre del producto -->
                        <h1 class="h2 fw-bold mb-3" style="color: #450050;">@producto.Nombre</h1>

                        <!-- Precio -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center">
                                <span class="h1 fw-bold me-3" style="color: #e753fe;">$@producto.Precio.ToString("N2")</span>
                                @if (producto.Stock > 0 && !producto.CompletamenteAgotado)
                                {
                                    <span class="text-success">
                                        <i class="fas fa-check me-1"></i>En stock
                                    </span>
                                }
                            </div>
                            <small class="text-muted">Precio final IVA incluido</small>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-4">
                            <h5 class="mb-3" style="color: #450050;">Descripción</h5>
                            <p class="text-muted">@(string.IsNullOrEmpty(producto.Descripcion) ? "Este producto de gimnasia rítmica es de la más alta calidad, diseñado para competencias profesionales y entrenamiento." : producto.Descripcion)</p>
                        </div>

                        <!-- SELECTOR DE COLOR (si el producto tiene variantes) -->
                        @if (producto.TieneVariantes && coloresDisponibles.Any())
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Color:</h5>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var color in coloresDisponibles)
                                    {
                                        var stockColor = producto.ObtenerStockPorColor(color);
                                        var estaAgotado = stockColor <= 0;
                                        var tieneStockLimitado = stockColor > 0 && stockColor < 5;

                                        <div class="color-option @(colorSeleccionado == color ? "selected" : "") @(estaAgotado ? "agotado" : "")"
                                             style="cursor: @(estaAgotado ? "not-allowed" : "pointer");"
                                             @onclick="() => SeleccionarColor(color)"
                                             title="@color - Stock: @stockColor unidades">

                                            <!-- Círculo de color -->
                                            <div class="color-circle mb-1"
                                                 style="background-color: @ObtenerColorHex(color);"></div>

                                            <!-- Nombre del color -->
                                            <small class="d-block fw-medium">@color</small>

                                            <!-- Estado del stock -->
                                            @if (estaAgotado)
                                            {
                                                <span class="badge bg-danger badge-sm">AGOTADO</span>
                                            }
                                            else if (tieneStockLimitado)
                                            {
                                                <span class="badge bg-warning text-dark badge-sm">@stockColor u.</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success badge-sm">@stockColor u.</span>
                                            }
                                        </div>
                                    }
                                </div>

                                @* Mensajes de color seleccionado / agotado, igual que en tu versión vieja *@
                                @if (!string.IsNullOrEmpty(colorSeleccionado))
                                {
                                    var stockColorSeleccionado = producto.ObtenerStockPorColor(colorSeleccionado);
                                    if (stockColorSeleccionado <= 0)
                                    {
                                        <div class="alert alert-danger mt-2">
                                            <i class="fas fa-times-circle me-2"></i>
                                            El color <strong>@colorSeleccionado</strong> está agotado.
                                            @if (coloresConStock.Any())
                                            {
                                                <span>Por favor selecciona otro color.</span>
                                            }
                                        </div>
                                    }
                                    else if (stockColorSeleccionado < 5)
                                    {
                                        <div class="alert alert-warning mt-2">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Color <strong>@colorSeleccionado</strong> - Solo quedan <strong>@stockColorSeleccionado</strong> unidades.
                                        </div>
                                    }
                                }

                                @if (coloresConStock.Count == 0 && coloresDisponibles.Any())
                                {
                                    <div class="alert alert-danger mt-2">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        Todos los colores están agotados temporalmente.
                                    </div>
                                }
                            </div>
                        }

                        <!-- SELECTOR DE TAMAÑO (si el producto tiene variantes) -->
                        @if (producto.TieneVariantes && tamaniosDisponibles.Any())
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Tamaño:</h5>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tamaño in tamaniosDisponibles)
                                    {
                                        <button class="btn @(tamanoSeleccionado == tamaño ? "btn-violeta" : "btn-outline-violeta")"
                                                @onclick="() => SeleccionarTamaño(tamaño)">
                                            @tamaño
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Selector de cantidad -->
                        @if (puedeAgregarAlCarrito)
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Cantidad</h5>
                                <div class="d-flex align-items-center gap-3" style="max-width: 200px;">
                                    <button class="btn btn-outline-secondary rounded-circle"
                                            @onclick="DecrementarCantidad"
                                            disabled="@(cantidad <= 1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number"
                                           class="form-control text-center"
                                           @bind="cantidad"
                                           @bind:event="oninput"
                                           min="1"
                                           max="@maximoCantidad"
                                           style="width: 80px;" />
                                    <button class="btn btn-outline-secondary rounded-circle"
                                            @onclick="IncrementarCantidad"
                                            disabled="@(cantidad >= maximoCantidad)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <small class="text-muted">Máximo: @maximoCantidad</small>
                                </div>

                                <!-- Advertencia si se excede el stock -->
                                @if (cantidad > maximoCantidad)
                                {
                                    <div class="alert alert-warning mt-2">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Solo hay @maximoCantidad unidades disponibles.
                                    </div>
                                }
                                else if (cantidad == maximoCantidad && maximoCantidad < 10)
                                {
                                    <div class="alert alert-info mt-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Estás comprando las últimas @maximoCantidad unidades.
                                    </div>
                                }
                            </div>

                            <!-- Resumen de selección -->
                            @if (producto.TieneVariantes && (!string.IsNullOrEmpty(colorSeleccionado) || !string.IsNullOrEmpty(tamanoSeleccionado)))
                            {
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <small class="text-muted d-block">Selección actual:</small>
                                            <span class="fw-medium">
                                                @producto.Nombre
                                                @if (!string.IsNullOrEmpty(colorSeleccionado) && colorSeleccionado != "Único")
                                                {
                                                    <text> - Color: @colorSeleccionado</text>
                                                }
                                                @if (!string.IsNullOrEmpty(tamanoSeleccionado) && tamanoSeleccionado != "Estándar")
                                                {
                                                    <text> - Tamaño: @tamanoSeleccionado</text>
                                                }
                                            </span>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">Total:</small>
                                            <span class="h5 fw-bold" style="color: #e753fe;">
                                                $@((producto.Precio * cantidad).ToString("N2"))
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Botones de acción -->
                            <div class="d-grid gap-3 mb-4">
                                <button class="btn btn-lg btn-violeta py-3"
                                        @onclick="AgregarAlCarrito"
                                        disabled="@(agregandoAlCarrito || !puedeAgregarAlCarrito || cantidad > maximoCantidad)">
                                    @if (agregandoAlCarrito)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Agregando...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-cart-plus me-2"></i>
                                        <span>Agregar al Carrito - $@((producto.Precio * cantidad).ToString("N2"))</span>
                                    }
                                </button>

                               

                                <!-- Enlace para ver carrito existente -->
                                @if (cantidadEnCarrito > 0)
                                {
                                    <div class="text-center mt-2">
                                        <a href="/carrito" class="btn btn-link position-relative"
                                           style="color: #e753fe; text-decoration: none;">
                                            <i class="fas fa-eye me-1"></i>
                                            Ver mi carrito
                                            <span class="badge rounded-pill ms-1 px-2"
                                                  style="background: #e753fe; color: white; font-size: 0.8rem;">
                                                @cantidadEnCarrito items
                                            </span>
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Este producto está temporalmente no disponible.
                                @if (producto.TieneVariantes && coloresConStock.Any())
                                {
                                    <div class="mt-1">
                                        Los siguientes colores están disponibles:
                                        @string.Join(", ", coloresConStock)
                                    </div>
                                }
                            </div>
                        }

                        <!-- Información adicional -->
                        <div class="mt-4 pt-4 border-top">
                            <h5 class="mb-3" style="color: #450050;">Información del Producto</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Categoría</small>
                                        <span class="fw-medium">
                                            @(producto.Categoria?.Nombre ?? "Sin categoría")
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Stock total</small>
                                        <span class="fw-medium">@producto.Stock unidades</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Estado</small>
                                        @if (producto.CompletamenteAgotado)
                                        {
                                            <span class="fw-medium text-danger">
                                                <i class="fas fa-times-circle me-1"></i>Completamente agotado
                                            </span>
                                        }
                                        else if (producto.AlgunColorAgotado)
                                        {
                                            <span class="fw-medium text-warning">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Stock limitado
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="fw-medium text-success">
                                                <i class="fas fa-check-circle me-1"></i>Disponible
                                            </span>
                                        }
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Variantes</small>
                                        <span class="fw-medium @(producto.TieneVariantes ? "text-info" : "text-muted")">
                                            @(producto.TieneVariantes ? "Con opciones" : "Sin opciones")
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Envío y garantía -->
                        <div class="mt-4">
                            <div class="row g-3">
                               
                                <div class="col-sm-4">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-shield-alt fa-2x mb-2" style="color: #e753fe;"></i>
                                        <small class="d-block fw-medium">Compra segura</small>
                                        <small class="text-muted">Datos protegidos</small>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-undo fa-2x mb-2" style="color: #e753fe;"></i>
                                        <small class="d-block fw-medium">Devoluciones</small>
                                        <small class="text-muted">30 días</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ProductoId { get; set; }

    private Producto producto;
    private bool cargando = true;
    private bool agregandoAlCarrito = false;
    private int cantidad = 1;

    // Variable para el contador del carrito
    private int cantidadEnCarrito = 0;

    // Variables para variantes
    private string colorSeleccionado = "";
    private string tamanoSeleccionado = "";
    private List<string> coloresDisponibles = new();
    private List<string> tamaniosDisponibles = new();
    private List<string> imagenesVariantes = new();

    // Nuevas variables para manejo de stock por color
    private List<string> coloresConStock = new();
    private int maximoCantidad = 0;
    private bool puedeAgregarAlCarrito = false;

    // Variables para mensajes
    private string? mensajeError;
    private string? mensajeExito;

    // TODO: Temporal - usar ID 1 hasta implementar login
    //private int usuarioIdTemporal = 1;

    protected override async Task OnInitializedAsync()
    {
        await CargarProducto();
        InicializarVariantes();
        ActualizarEstadoCompra();

        // Cargar la cantidad de items en el carrito
        await CargarCantidadCarrito();
    }

    private async Task CargarProducto()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProducto(ProductoId);

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                producto = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargado producto: {producto.Nombre}");
                Console.WriteLine($"- Tiene variantes: {producto.TieneVariantes}");
                Console.WriteLine($"- Colores: {producto.ColoresDisponibles}");
                Console.WriteLine($"- Tamaños: {producto.TamaniosDisponibles}");
                Console.WriteLine($"- StockPorColor: {producto.StockPorColor}");
                Console.WriteLine($"- CompletamenteAgotado: {producto.CompletamenteAgotado}");
                Console.WriteLine($"- AlgunColorAgotado: {producto.AlgunColorAgotado}");

                // Mostrar stock por color en consola
                if (producto.TieneVariantes && !string.IsNullOrEmpty(producto.ColoresDisponibles))
                {
                    var diccionario = producto.ObtenerStockPorColorDiccionario();
                    Console.WriteLine($"- Stock por color: {string.Join(", ", diccionario.Select(kv => $"{kv.Key}: {kv.Value}"))}");
                }
            }
            else
            {
                Console.WriteLine("✗ Producto no encontrado");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
        }

        cargando = false;
        StateHasChanged();
    }

    private void InicializarVariantes()
    {
        // Usar los métodos helper de la clase Producto
        if (producto != null)
        {
            coloresDisponibles = producto.ObtenerColoresLista();
            tamaniosDisponibles = producto.ObtenerTamaniosLista();
            imagenesVariantes = producto.ObtenerImagenesVariantesLista();
            coloresConStock = producto.ColoresConStockLista;

            Console.WriteLine($"Colores disponibles: {string.Join(", ", coloresDisponibles)}");
            Console.WriteLine($"Colores con stock: {string.Join(", ", coloresConStock)}");
            Console.WriteLine($"Tamaños disponibles: {string.Join(", ", tamaniosDisponibles)}");
            Console.WriteLine($"Imágenes variantes: {string.Join(", ", imagenesVariantes)}");

            // Si no tiene variantes definidas, usar valores por defecto
            if (!coloresDisponibles.Any())
            {
                coloresDisponibles = producto.TieneVariantes
                    ? new List<string> { "Rojo", "Azul", "Verde", "Rosa", "Dorado" }
                    : new List<string> { "Único" };
            }

            if (!tamaniosDisponibles.Any())
            {
                tamaniosDisponibles = producto.TieneVariantes
                    ? new List<string> { "S", "M", "L", "XL" }
                    : new List<string> { "Estándar" };
            }

            // Seleccionar primera opción por defecto
            if (coloresDisponibles.Any())
            {
                // Seleccionar primer color con stock si existe
                if (coloresConStock.Any())
                {
                    colorSeleccionado = coloresConStock.First();
                }
                else
                {
                    colorSeleccionado = coloresDisponibles.First();
                }
            }

            if (tamaniosDisponibles.Any())
                tamanoSeleccionado = tamaniosDisponibles.First();
        }
    }

    private void ActualizarEstadoCompra()
    {
        if (producto == null) return;

        if (producto.TieneVariantes && !string.IsNullOrEmpty(colorSeleccionado))
        {
            // Producto con variantes: usar stock del color seleccionado
            maximoCantidad = producto.ObtenerStockPorColor(colorSeleccionado);
            puedeAgregarAlCarrito = maximoCantidad > 0;
        }
        else
        {
            // Producto sin variantes: usar stock general
            maximoCantidad = producto.Stock;
            puedeAgregarAlCarrito = maximoCantidad > 0;
        }

        // Ajustar cantidad si excede el máximo
        if (cantidad > maximoCantidad && maximoCantidad > 0)
        {
            cantidad = maximoCantidad;
        }
    }

    private async Task CargarCantidadCarrito()
    {
        try
        {
            var respuesta = await CarritoServicio.ObtenerItemsCarrito();
            if (!respuesta.Error && respuesta.Respuesta != null)
            {
                cantidadEnCarrito = respuesta.Respuesta.Sum(i => i.Cantidad);
            }
        }
        catch
        {
            cantidadEnCarrito = 0;
        }
    }

    private void IncrementarCantidad()
    {
        if (cantidad < maximoCantidad)
        {
            cantidad++;
        }
    }

    private void DecrementarCantidad()
    {
        if (cantidad > 1)
        {
            cantidad--;
        }
    }

    private void SeleccionarColor(string color)
    {
        var stockColor = producto.ObtenerStockPorColor(color);
        if (stockColor > 0) // Solo permitir seleccionar si tiene stock
        {
            colorSeleccionado = color;
            ActualizarEstadoCompra();
            StateHasChanged();
            Console.WriteLine($"Color seleccionado: {color} (Stock: {stockColor})");
        }
        else
        {
            Console.WriteLine($"No se puede seleccionar {color} - Está agotado");
        }
    }

    private void SeleccionarTamaño(string tamaño)
    {
        tamanoSeleccionado = tamaño;
        StateHasChanged();
        Console.WriteLine($"Tamaño seleccionado: {tamaño}");
    }

    private void CambiarImagenVariante(string imagenUrl)
    {
        producto.ImagenUrl = imagenUrl;
        StateHasChanged();
        Console.WriteLine($"Imagen cambiada a: {imagenUrl}");
    }

    private async Task AgregarAlCarrito()
    {
        if (!puedeAgregarAlCarrito || cantidad > maximoCantidad) return;

        agregandoAlCarrito = true;
        mensajeError = null;
        mensajeExito = null;
        StateHasChanged();

        try
        {
            Console.WriteLine("📦 Agregando producto al carrito...");

            // 1) Obtener el usuario actual desde el SelectorUsuario (localStorage)
            var usuarioSeleccionadoId = await SesionUsuarioServicio.ObtenerUsuarioIdAsync();

            // 2) Si no hay ninguno guardado, usar el usuario 1 como valor por defecto
            var usuarioId = usuarioSeleccionadoId ?? 1;

            Console.WriteLine($"- Usuario actual usado para la compra: {usuarioId}");

            // 3) Crear DTO para agregar al carrito
            var itemDTO = new AgregarAlCarritoDTO
            {
                UsuarioId = usuarioId,   // ← AHORA usa el usuario del selector (o 1 por defecto)
                ProductoId = producto.Id,
                Cantidad = cantidad,
                PrecioUnitario = producto.Precio,
                Color = producto.TieneVariantes ? colorSeleccionado : null,
                Tamaño = producto.TieneVariantes ? tamanoSeleccionado : null
            };

            Console.WriteLine($"- Producto: {producto.Nombre}");
            if (producto.TieneVariantes)
            {
                Console.WriteLine($"- Color: {itemDTO.Color}");
                Console.WriteLine($"- Tamaño: {itemDTO.Tamaño}");
            }
            Console.WriteLine($"- Cantidad: {itemDTO.Cantidad}");
            Console.WriteLine($"- Precio unitario: ${itemDTO.PrecioUnitario:N2}");
            Console.WriteLine($"- Total: ${(producto.Precio * cantidad):N2}");

            // 4) Llamar al servicio
            var respuesta = await CarritoServicio.AgregarItem(itemDTO);

            if (!respuesta.Error)
            {
                mensajeExito = $"✅ {producto.Nombre} agregado al carrito correctamente";
                Console.WriteLine("✅ Producto agregado al carrito exitosamente");

                // Actualizar contador del carrito
                await CargarCantidadCarrito();
            }
            else
            {
                var mensajeErrorServidor = await respuesta.ObtenerError();
                mensajeError = $"❌ Error: {mensajeErrorServidor}";
                Console.WriteLine($"❌ Error del servidor: {mensajeErrorServidor}");
                await JS.InvokeVoidAsync("alert", mensajeError);
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"❌ Error de conexión: {ex.Message}";
            Console.WriteLine($"❌ Error en AgregarAlCarrito: {ex.Message}");
            await JS.InvokeVoidAsync("alert", mensajeError);
        }

        agregandoAlCarrito = false;
        StateHasChanged();
    }


    private void ComprarAhora()
    {
        if (puedeAgregarAlCarrito && cantidad <= maximoCantidad)
        {
            Console.WriteLine("⚡ COMPRAR AHORA:");
            Console.WriteLine($"- Producto: {producto.Nombre}");
            if (producto.TieneVariantes)
            {
                Console.WriteLine($"- Color: {colorSeleccionado}");
                Console.WriteLine($"- Tamaño: {tamanoSeleccionado}");
                Console.WriteLine($"- Stock del color: {producto.ObtenerStockPorColor(colorSeleccionado)} unidades");
            }
            Console.WriteLine($"- Cantidad: {cantidad}");
            Console.WriteLine($"- Total: ${(producto.Precio * cantidad):N2}");

            // Primero agregar al carrito, luego redirigir al checkout
            AgregarAlCarrito().ContinueWith(async task =>
            {
                if (mensajeExito != null && !mensajeExito.Contains("Error"))
                {
                    // Si se agregó correctamente, redirigir al checkout
                    // Navigation.NavigateTo($"/checkout?productoId={producto.Id}&color={colorSeleccionado}&tamaño={tamanoSeleccionado}&cantidad={cantidad}");
                    Console.WriteLine("➡️ Redirigiendo a checkout...");
                }
            });
        }
    }

    private string ObtenerColorHex(string colorNombre)
    {
        var colores = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            {"Rojo", "#dc3545"}, {"Azul", "#0d6efd"}, {"Verde", "#198754"},
            {"Amarillo", "#ffc107"}, {"Naranja", "#fd7e14"}, {"Rosa", "#d63384"},
            {"Morado", "#6f42c1"}, {"Negro", "#000000"}, {"Blanco", "#ffffff"},
            {"Gris", "#6c757d"}, {"Dorado", "#ffd700"}, {"Plateado", "#c0c0c0"},
            {"Celeste", "#0dcaf0"}, {"Violeta", "#6f42c1"}, {"Marron", "#8b4513"},
            {"Lila", "#c8a2c8"}, {"Turquesa", "#40e0d0"}, {"Beige", "#f5f5dc"},
            {"Bordo", "#800000"}, {"Mostaza", "#ffdb58"}
        };

        return colores.ContainsKey(colorNombre) ? colores[colorNombre] : "#6c757d";
    }
}

<style>
    .btn-violeta {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%) !important;
        border: none !important;
        color: white !important;
        transition: all 0.3s ease;
    }

        .btn-violeta:hover {
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.4) !important;
            transform: translateY(-2px);
        }

    .btn-outline-violeta {
        color: #e753fe !important;
        border-color: #e753fe !important;
        background: transparent !important;
        transition: all 0.3s ease;
    }

        .btn-outline-violeta:hover {
            background: linear-gradient(180deg, rgba(69, 0, 80, 0.1) 0%, rgba(231, 83, 254, 0.1) 100%) !important;
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.2) !important;
        }

    .btn-outline-secondary.rounded-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .border.rounded {
        transition: all 0.3s ease;
    }

        .border.rounded:hover {
            border-color: #e753fe !important;
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.1);
        }

    /* Estilos para los botones de variantes */
    .btn-outline-violeta, .btn-violeta {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    /* Estilos para opciones de color */
    .color-option {
        width: 90px;
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        text-align: center;
        transition: all 0.2s;
    }

        .color-option:hover:not(.agotado) {
            border-color: #e753fe;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 83, 254, 0.2);
        }

        .color-option.selected {
            border-color: #e753fe;
            background-color: rgba(231, 83, 254, 0.05);
        }

        .color-option.agotado {
            opacity: 0.5;
            position: relative;
        }

            .color-option.agotado::after {
                content: "✗";
                position: absolute;
                top: 5px;
                right: 5px;
                color: #dc3545;
                font-weight: bold;
            }

    .color-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 0 auto;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .color-circle-sm {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
    }

    .badge-sm {
        font-size: 0.65rem;
        padding: 2px 6px;
        margin-top: 2px;
        display: block;
    }
</style>