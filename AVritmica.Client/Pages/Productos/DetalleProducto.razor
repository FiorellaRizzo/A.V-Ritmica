@page "/producto/detalle/{ProductoId:int}"
@using AVritmica.BD.Data.Entity
@using AVritmica.Client.Servicios
@inject IProductoService ProductoService
@inject NavigationManager Navigation

<PageTitle>Avítmica - Detalle del Producto</PageTitle>

<!-- Breadcrumb -->
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="/catalogo" class="text-decoration-none" style="color: #e753fe;">
                    <i class="fas fa-arrow-left me-1"></i>Volver al Catálogo
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Detalle del Producto</li>
        </ol>
    </nav>
</div>

@if (cargando)
{
    <div class="container text-center py-5">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #e753fe;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3" style="color: #450050;">Cargando información del producto...</p>
    </div>
}
else if (producto == null)
{
    <div class="container">
        <div class="alert alert-danger text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>Producto no encontrado</h4>
            <p>El producto que buscas no existe o ha sido eliminado.</p>
            <a href="/catalogo" class="btn 








mt-2">
                <i class="fas fa-store me-1"></i>Volver al Catálogo
            </a>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="row">
            <!-- Columna de Imagen -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="text-center">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl"
                                     class="img-fluid rounded"
                                     style="max-height: 400px; object-fit: contain;"
                                     alt="@producto.Nombre"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/500x400/450050/ffffff?text=Producto'">
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center" style="height: 400px; background: linear-gradient(180deg, rgba(231, 83, 254, 0.05) 0%, rgba(69, 0, 80, 0.05) 100%);">
                                    <i class="fas fa-ribbon fa-7x" style="color: #e753fe; opacity: 0.3;"></i>
                                </div>
                            }
                        </div>

                        <!-- Galería de variantes -->
                        @if (imagenesVariantes.Any())
                        {
                            <div class="mt-4">
                                <h6 style="color: #450050;">Otras variantes:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var img in imagenesVariantes)
                                    {
                                        <div class="border rounded p-1"
                                             style="cursor: pointer; width: 60px; height: 60px;"
                                             @onclick="() => CambiarImagenVariante(img)">
                                            <img src="@img"
                                                 class="w-100 h-100"
                                                 style="object-fit: cover;"
                                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60/450050/ffffff'">
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Columna de Información -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <!-- Estado del stock -->
                        <div class="mb-3">
                            @if (producto.Stock > 0)
                            {
                                <span class="badge rounded-pill p-2"
                                      style="background: linear-gradient(180deg, #28a745 0%, #20c997 100%); color: #28a745 0%;">
                                    <i class="fas fa-check-circle me-1"></i>Disponible
                                </span>
                                <small class="text-muted ms-2">
                                    <i class="fas fa-cube me-1"></i>@producto.Stock unidades disponibles
                                </small>
                            }
                            else
                            {
                                <span class="badge rounded-pill p-2"
                                      style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%); color:#dc3545 0%;">
                                    <i class="fas fa-times-circle me-1"></i>Agotado
                                </span>
                            }
                        </div>

                        <!-- Nombre del producto -->
                        <h1 class="h2 fw-bold mb-3" style="color: #450050;">@producto.Nombre</h1>

                        <!-- Precio -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center">
                                <span class="h1 fw-bold me-3" style="color: #e753fe;">$@producto.Precio.ToString("N2")</span>
                                @if (producto.Stock > 0)
                                {
                                    <span class="text-success">
                                        <i class="fas fa-check me-1"></i>En stock
                                    </span>
                                }
                            </div>
                            <small class="text-muted">Precio final IVA incluido</small>
                        </div>

                        <!-- Descripción -->
                        <div class="mb-4">
                            <h5 class="mb-3" style="color: #450050;">Descripción</h5>
                            <p class="text-muted">@(string.IsNullOrEmpty(producto.Descripcion) ? "Este producto de gimnasia rítmica es de la más alta calidad, diseñado para competencias profesionales y entrenamiento." : producto.Descripcion)</p>
                        </div>

                        <!-- SELECTOR DE COLOR (si el producto tiene variantes) -->
                        @if (producto.TieneVariantes || coloresDisponibles.Count > 1)
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Color:</h5>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var color in coloresDisponibles)
                                    {
                                        <button class="btn @(colorSeleccionado == color ? "btn-violeta" : "btn-outline-violeta")"
                                                @onclick="() => SeleccionarColor(color)">
                                            @color
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        <!-- SELECTOR DE TAMAÑO (si el producto tiene variantes) -->
                        @if (producto.TieneVariantes || tamaniosDisponibles.Count > 1)
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Tamaño:</h5>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tamaño in tamaniosDisponibles)
                                    {
                                        <button class="btn @(tamanoSeleccionado == tamaño ? "btn-violeta" : "btn-outline-violeta")"
                                                @onclick="() => SeleccionarTamaño(tamaño)">
                                            @tamaño
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Selector de cantidad -->
                        @if (producto.Stock > 0)
                        {
                            <div class="mb-4">
                                <h5 class="mb-3" style="color: #450050;">Cantidad</h5>
                                <div class="d-flex align-items-center gap-3" style="max-width: 200px;">
                                    <button class="btn btn-outline-secondary rounded-circle"
                                            @onclick="DecrementarCantidad"
                                            disabled="@(cantidad <= 1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number"
                                           class="form-control text-center"
                                           @bind="cantidad"
                                           min="1"
                                           max="@producto.Stock"
                                           style="width: 80px;" />
                                    <button class="btn btn-outline-secondary rounded-circle"
                                            @onclick="IncrementarCantidad"
                                            disabled="@(cantidad >= producto.Stock)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <small class="text-muted">Máximo: @producto.Stock</small>
                                </div>
                            </div>

                            <!-- Resumen de selección -->
                            @if (producto.TieneVariantes || coloresDisponibles.Count > 1 || tamaniosDisponibles.Count > 1)
                            {
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <small class="text-muted d-block">Selección actual:</small>
                                            <span class="fw-medium">
                                                @producto.Nombre
                                                @if (!string.IsNullOrEmpty(colorSeleccionado) && colorSeleccionado != "Único")
                                                {
                                                    <text> - Color: @colorSeleccionado</text>
                                                }
                                                @if (!string.IsNullOrEmpty(tamanoSeleccionado) && tamanoSeleccionado != "Estándar")
                                                {
                                                    <text> - Tamaño: @tamanoSeleccionado</text>
                                                }
                                            </span>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">Total:</small>
                                            <span class="h5 fw-bold" style="color: #e753fe;">
                                                $@(producto.Precio* cantidad)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Botones de acción -->
                            <div class="d-grid gap-3 mb-4">
                                <button class="btn btn-lg btn-violeta py-3"
                                        @onclick="AgregarAlCarrito"
                                        disabled="@(producto.Stock <= 0 || agregandoAlCarrito)">
                                    @if (agregandoAlCarrito)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Agregando...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-cart-plus me-2"></i>
                                        <span>Agregar al Carrito - $@((producto.Precio * cantidad).ToString("N2"))</span>
                                    }
                                </button>

                                <button class="btn btn-outline-violeta btn-lg py-3" @onclick="ComprarAhora">
                                    <i class="fas fa-bolt me-2"></i>Comprar Ahora
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Este producto está temporalmente agotado.
                            </div>
                        }

                        <!-- Información adicional -->
                        <div class="mt-4 pt-4 border-top">
                            <h5 class="mb-3" style="color: #450050;">Información del Producto</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Categoría</small>
                                        <span class="fw-medium">
                                            @(producto.Categoria?.Nombre ?? "Sin categoría")
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Stock actual</small>
                                        <span class="fw-medium">@producto.Stock unidades</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Estado</small>
                                        <span class="fw-medium @(producto.Stock > 0 ? "text-success" : "text-danger")">
                                            @(producto.Stock > 0 ? "Disponible" : "Agotado")
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Variantes</small>
                                        <span class="fw-medium @(producto.TieneVariantes ? "text-info" : "text-muted")">
                                            @(producto.TieneVariantes ? "Con opciones" : "Sin opciones")
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Envío y garantía -->
                        <div class="mt-4">
                            <div class="row g-3">
                                <div class="col-sm-4">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-shipping-fast fa-2x mb-2" style="color: #e753fe;"></i>
                                        <small class="d-block fw-medium">Envío gratis</small>
                                        <small class="text-muted">En compras > $50.000</small>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-shield-alt fa-2x mb-2" style="color: #e753fe;"></i>
                                        <small class="d-block fw-medium">Compra segura</small>
                                        <small class="text-muted">Datos protegidos</small>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-undo fa-2x mb-2" style="color: #e753fe;"></i>
                                        <small class="d-block fw-medium">Devoluciones</small>
                                        <small class="text-muted">30 días</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ProductoId { get; set; }

    private Producto producto;
    private bool cargando = true;
    private bool agregandoAlCarrito = false;
    private int cantidad = 1;

    // Variables para variantes
    private string colorSeleccionado = "";
    private string tamanoSeleccionado = "";
    private List<string> coloresDisponibles = new();
    private List<string> tamaniosDisponibles = new();
    private List<string> imagenesVariantes = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarProducto();
        InicializarVariantes();
    }

    private async Task CargarProducto()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProducto(ProductoId);

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                producto = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargado producto: {producto.Nombre}");
                Console.WriteLine($"- Tiene variantes: {producto.TieneVariantes}");
                Console.WriteLine($"- Colores: {producto.ColoresDisponibles}");
                Console.WriteLine($"- Tamaños: {producto.TamaniosDisponibles}");
            }
            else
            {
                Console.WriteLine("✗ Producto no encontrado");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
        }

        cargando = false;
        StateHasChanged();
    }

    private void InicializarVariantes()
    {
        // Usar los métodos helper de la clase Producto
        if (producto != null)
        {
            coloresDisponibles = producto.ObtenerColoresLista();
            tamaniosDisponibles = producto.ObtenerTamaniosLista();
            imagenesVariantes = producto.ObtenerImagenesVariantesLista();

            Console.WriteLine($"Colores disponibles: {string.Join(", ", coloresDisponibles)}");
            Console.WriteLine($"Tamaños disponibles: {string.Join(", ", tamaniosDisponibles)}");
            Console.WriteLine($"Imágenes variantes: {string.Join(", ", imagenesVariantes)}");

            // Si no tiene variantes definidas, usar valores por defecto
            if (!coloresDisponibles.Any())
            {
                coloresDisponibles = producto.TieneVariantes
                    ? new List<string> { "Rojo", "Azul", "Verde", "Rosa", "Dorado" }
                    : new List<string> { "Único" };
            }

            if (!tamaniosDisponibles.Any())
            {
                tamaniosDisponibles = producto.TieneVariantes
                    ? new List<string> { "S", "M", "L", "XL" }
                    : new List<string> { "Estándar" };
            }

            // Seleccionar primera opción por defecto
            if (coloresDisponibles.Any())
                colorSeleccionado = coloresDisponibles.First();

            if (tamaniosDisponibles.Any())
                tamanoSeleccionado = tamaniosDisponibles.First();
        }
    }

    private void IncrementarCantidad()
    {
        if (cantidad < producto.Stock)
        {
            cantidad++;
        }
    }

    private void DecrementarCantidad()
    {
        if (cantidad > 1)
        {
            cantidad--;
        }
    }

    private void SeleccionarColor(string color)
    {
        colorSeleccionado = color;
        StateHasChanged();
        Console.WriteLine($"Color seleccionado: {color}");
    }

    private void SeleccionarTamaño(string tamaño)
    {
        tamanoSeleccionado = tamaño;
        StateHasChanged();
        Console.WriteLine($"Tamaño seleccionado: {tamaño}");
    }

    private void CambiarImagenVariante(string imagenUrl)
    {
        producto.ImagenUrl = imagenUrl;
        StateHasChanged();
        Console.WriteLine($"Imagen cambiada a: {imagenUrl}");
    }

    private async Task AgregarAlCarrito()
    {
        if (producto == null || producto.Stock <= 0) return;

        agregandoAlCarrito = true;
        StateHasChanged();

        try
        {
            // Preparar datos de la variante seleccionada
            var varianteSeleccionada = new
            {
                ProductoId = producto.Id,
                ProductoNombre = producto.Nombre,
                Color = colorSeleccionado,
                Tamaño = tamanoSeleccionado,
                Cantidad = cantidad,
                PrecioUnitario = producto.Precio,
                Total = producto.Precio * cantidad
            };

            Console.WriteLine("📦 AGREGANDO AL CARRITO:");
            Console.WriteLine($"- Producto: {varianteSeleccionada.ProductoNombre}");
            Console.WriteLine($"- Color: {varianteSeleccionada.Color}");
            Console.WriteLine($"- Tamaño: {varianteSeleccionada.Tamaño}");
            Console.WriteLine($"- Cantidad: {varianteSeleccionada.Cantidad}");
            Console.WriteLine($"- Total: ${varianteSeleccionada.Total:N2}");

            await Task.Delay(1000); // Simulación

            Console.WriteLine("✅ Producto agregado al carrito (simulado)");

            // Mostrar mensaje temporal
            // TODO: Implementar lógica real del carrito
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}");
        }

        agregandoAlCarrito = false;
        StateHasChanged();
    }

    private void ComprarAhora()
    {
        if (producto.Stock > 0)
        {
            Console.WriteLine("⚡ COMPRAR AHORA:");
            Console.WriteLine($"- Producto: {producto.Nombre}");
            Console.WriteLine($"- Color: {colorSeleccionado}");
            Console.WriteLine($"- Tamaño: {tamanoSeleccionado}");
            Console.WriteLine($"- Cantidad: {cantidad}");
            Console.WriteLine($"- Total: ${(producto.Precio * cantidad):N2}");

            // TODO: Redirigir al checkout
            // Navigation.NavigateTo($"/checkout?productoId={producto.Id}&color={colorSeleccionado}&tamaño={tamanoSeleccionado}&cantidad={cantidad}");
        }
    }
}

<style>
    .btn-violeta {
        background: linear-gradient(180deg, #450050 0%, #e753fe 100%) !important;
        border: none !important;
        color: white !important;
        transition: all 0.3s ease;
    }

        .btn-violeta:hover {
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.4) !important;
            transform: translateY(-2px);
        }

    .btn-outline-violeta {
        color: #e753fe !important;
        border-color: #e753fe !important;
        background: transparent !important;
        transition: all 0.3s ease;
    }

        .btn-outline-violeta:hover {
            background: linear-gradient(180deg, rgba(69, 0, 80, 0.1) 0%, rgba(231, 83, 254, 0.1) 100%) !important;
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.2) !important;
        }

    .btn-outline-secondary.rounded-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items-center;
        justify-content: center;
    }

    .border.rounded {
        transition: all 0.3s ease;
    }

        .border.rounded:hover {
            border-color: #e753fe !important;
            box-shadow: 0 5px 15px rgba(231, 83, 254, 0.1);
        }

    /* Estilos para los botones de variantes */
    .btn-outline-violeta, .btn-violeta {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
    }
</style>