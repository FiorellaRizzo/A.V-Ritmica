@page "/catalogo"
@page "/catalogo/categoria/{CategoriaId:int}"
@using AVritmica.BD.Data.Entity
@using AVritmica.Client.Servicios
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject NavigationManager Navigation

<PageTitle>Avítmica - Catálogo</PageTitle>

<!-- Banner Hero con TU gradiente violeta -->
<div class="container-fluid bg-custom-gradient text-white py-5 mb-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold">Equipamiento de Gimnasia Rítmica</h1>
                <p class="lead mb-4">Descubre nuestra selección de productos de alta calidad para gimnasia rítmica.</p>
                <div class="d-flex gap-2">
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-shipping-fast me-1"></i> Envíos a todo el país
                    </span>
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-medal me-1"></i> Calidad profesional
                    </span>
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-headset me-1"></i> Soporte especializado
                    </span>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="d-inline-block"
                     style="background: linear-gradient(145deg,
                    rgba(255,255,255,0.15) 0%,
                    rgba(255,255,255,0.05) 100%);
                border-radius: 20px;
                padding: 25px;
                border: 2px solid rgba(255,255,255,0.25);
                box-shadow: 0 10px 30px rgba(0,0,0,0.2),
                            inset 0 1px 0 rgba(255,255,255,0.2);">

                    <img src="images/Logonuevo.png"
                         alt="Logo AV Rítmica"
                         class="img-fluid"
                         style="max-height: 150px;
                    filter: brightness(0) invert(1)
                            drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filtros de Categoría -->
    <div class="mb-5">
        <h3 class="text-center mb-4" style="color: #450050;">Nuestras Categorías</h3>
        <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
            <a href="/catalogo" class="btn @(CategoriaId == 0 ? "btn-violeta" : "btn-outline-violeta")"
               style="@(CategoriaId == 0 ? "background: linear-gradient(180deg, #450050 0%, #e753fe 100%); border: none; color: violet;" : "color: #e753fe; border-color: #e753fe; background: transparent;")">
                Todos
            </a>
            @if (categorias != null)
            {
                @foreach (var categoria in categorias)
                {
                    <a href="/catalogo/categoria/@categoria.Id"
                       class="btn @(CategoriaId == categoria.Id ? "btn-violeta" : "btn-outline-violeta")"
                       style="@(CategoriaId == categoria.Id ? "background: linear-gradient(180deg, #450050 0%, #e753fe 100%); border: none; color: violet;" : "color: #e753fe; border-color: #e753fe; background: transparent;")">
                        @categoria.Nombre
                    </a>
                }
            }
        </div>
    </div>

    <!-- Productos -->
    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #e753fe;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" style="color: #450050;">Cargando productos...</p>
        </div>
    }
    else if (productos == null || !productos.Any())
    {
        <div class="alert text-center py-5" style="background: linear-gradient(180deg, rgba(231, 83, 254, 0.1) 0%, rgba(69, 0, 80, 0.1) 100%); border-color: #e753fe;">
            <i class="fas fa-box-open fa-4x mb-3" style="color: #e753fe;"></i>
            <h4 style="color: #450050;">No hay productos disponibles</h4>
            <p class="text-muted">No se encontraron productos en el catálogo.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var producto in productos)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                        <!-- Imagen del producto -->
                        <div class="position-relative overflow-hidden" style="height: 200px; background: linear-gradient(180deg, rgba(231, 83, 254, 0.05) 0%, rgba(69, 0, 80, 0.05) 100%);">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl"
                                     class="card-img-top h-100 w-100 p-3"
                                     style="object-fit: contain;"
                                     alt="@producto.Nombre"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200/450050/ffffff?text=Av%C3%ADtmica'">
                            }
                            else
                            {
                                <div class="h-100 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-ribbon fa-5x" style="color: #e753fe; opacity: 0.2;"></i>
                                </div>
                            }

                            <!-- Badge de stock -->
                            <div class="position-absolute top-0 end-0 m-2">
                                @if (producto.Stock > 0)
                                {
                                    <span class="badge shadow" style="background: linear-gradient(180deg, #28a745 0%, #20c997 100%);">
                                        <i class="fas fa-check-circle me-1"></i>Disponible
                                    </span>
                                }
                                else
                                {
                                    <span class="badge shadow" style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);">
                                        <i class="fas fa-times-circle me-1"></i>Agotado
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <!-- Nombre -->
                            <h5 class="card-title text-dark mb-2">@producto.Nombre</h5>

                            <!-- Descripción -->
                            <p class="card-text text-muted small flex-grow-1 mb-3">
                                @GetShortDescription(producto.Descripcion)
                            </p>

                            <!-- Precio -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <span class="h4 fw-bold" style="color: #450050;">$@producto.Precio.ToString("N2")</span>
                                    @if (producto.Stock > 0)
                                    {
                                        <small class="text-success d-block">
                                            <i class="fas fa-cube me-1"></i>@producto.Stock unidades
                                        </small>
                                    }
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-violeta"
                                        @onclick="() => VerDetalle(producto.Id)"
                                        style="color: #e753fe; border-color: #e753fe;">
                                    <i class="fas fa-eye me-2"></i>Ver Detalles
                                </button>

                                @if (producto.Stock > 0)
                                {
                                    <button class="btn btn-violeta"
                                            @onclick="() => AgregarAlCarrito(producto)"
                                            style="background: linear-gradient(180deg, #450050 0%, #e753fe 100%); border: none;">
                                        <i class="fas fa-cart-plus me-2"></i>Agregar al Carrito
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-secondary" disabled>
                                        <i class="fas fa-ban me-2"></i>Sin Stock
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int CategoriaId { get; set; }

    private List<Producto> productos = new();
    private List<Categoria> categorias = new();
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarCategorias();
        await CargarProductos();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (CategoriaId > 0)
        {
            await CargarProductosPorCategoria();
        }
        else
        {
            await CargarProductos();
        }
    }

    private async Task CargarProductos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProductos();

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                productos = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargados {productos.Count} productos");
            }
            else
            {
                productos = new List<Producto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
            productos = new List<Producto>();
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task CargarProductosPorCategoria()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProductosPorCategoria(CategoriaId);

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                productos = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargados {productos.Count} productos de categoría {CategoriaId}");
            }
            else
            {
                productos = new List<Producto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
            productos = new List<Producto>();
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task CargarCategorias()
    {
        try
        {
            var respuesta = await CategoriaService.GetCategorias();

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                categorias = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargadas {categorias.Count} categorías");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error cargando categorías: {ex.Message}");
        }
    }

    private string GetShortDescription(string descripcion)
    {
        if (string.IsNullOrEmpty(descripcion))
            return "Producto de gimnasia rítmica de alta calidad.";

        if (descripcion.Length > 80)
            return descripcion.Substring(0, 80) + "...";

        return descripcion;
    }

    private void VerDetalle(int productoId)
    {
        Navigation.NavigateTo($"/producto/detalle/{productoId}");
    }

    private void AgregarAlCarrito(Producto producto)
    {
        Console.WriteLine($"Agregando '{producto.Nombre}' al carrito");
        // TODO: Implementar lógica del carrito
    }
}

