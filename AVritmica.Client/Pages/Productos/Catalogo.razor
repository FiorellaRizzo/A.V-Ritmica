@page "/catalogo"
@page "/catalogo/categoria/{CategoriaId:int}"
@using AVritmica.BD.Data.Entity
@using AVritmica.Client.Servicios
@using AVritmica.Client.Servicios.Entidades
@using AVritmica.Shared.DTO
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject ICarritoServicio CarritoServicio
@inject ICarritoProductoServicio CarritoProductoService
@inject NavigationManager Navigation

<PageTitle>Avítmica - Catálogo</PageTitle>


<div class="container-fluid bg-custom-gradient text-white py-5 mb-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold">Equipamiento de Gimnasia Rítmica</h1>
                <p class="lead mb-4">Descubre nuestra selección de productos de alta calidad para gimnasia rítmica.</p>
                <div class="d-flex gap-2">
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-shipping-fast me-1"></i> Envíos a todo el país
                    </span>
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-medal me-1"></i> Calidad profesional
                    </span>
                    <span class="badge bg-light text-dark p-2" style="color: #450050 !important;">
                        <i class="fas fa-headset me-1"></i> Soporte especializado
                    </span>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="d-inline-block"
                     style="background: linear-gradient(145deg,
                    rgba(255,255,255,0.15) 0%,
                    rgba(255,255,255,0.05) 100%);
                border-radius: 20px;
                padding: 25px;
                border: 2px solid rgba(255,255,255,0.25);
                box-shadow: 0 10px 30px rgba(0,0,0,0.2),
                            inset 0 1px 0 rgba(255,255,255,0.2);">

                    <img src="images/Logonuevo.png"
                         alt="Logo AV Rítmica"
                         class="img-fluid"
                         style="max-height: 150px;
                    filter: brightness(0) invert(1)
                            drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
                </div>
            </div>
        </div>

        <!-- Botón del Carrito - Responsive -->
        <div class="position-absolute" style="top: 15px; right: 15px; z-index: 1000;">
            <a class="btn position-relative p-1 p-sm-2 d-flex align-items-center carrito-btn"
               href="/carrito"
               title="Ver carrito"
               style="background: rgba(69, 0, 80, 0.9);
              color: white;
              border: 1px solid rgba(231, 83, 254, 0.5);
              border-radius: 8px;
              transition: all 0.3s ease;">

                <i class="fas fa-shopping-cart"></i>
                <span class="d-none d-sm-inline ms-1" style="font-size: 0.9rem;">Carrito</span>

                @if (cantidadEnCarrito > 0)
                {
                    <span class="ms-1 badge rounded-pill px-1 py-0"
                          style="background: #e753fe;
                             color: white;
                             font-size: 0.7rem;">
                        @cantidadEnCarrito
                    </span>
                }
            </a>
        </div>

        <style>
            .carrito-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(231, 83, 254, 0.4) !important;
                background: rgba(69, 0, 80, 1) !important;
            }

            @@media (max-width: 768px) {
                .carrito-btn {
                    padding: 4px 6px !important;
                    font-size: 0.8rem;
                }
            }
        </style>
    </div>
</div>

<div class="container">
    <!-- Filtros de Categoría -->
    <div class="mb-5">
        <h3 class="text-center mb-4" style="color: #450050;">Nuestras Categorías</h3>
        <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
            <a href="/catalogo" class="btn @(CategoriaId == 0 ? "btn-violeta" : "btn-outline-violeta")"
               style="@(CategoriaId == 0 ? "background: linear-gradient(180deg, #450050 0%, #e753fe 100%); border: none; color: violet;" : "color: #e753fe; border-color: #e753fe; background: transparent;")">
                Todos
            </a>
            @if (categorias != null)
            {
                @foreach (var categoria in categorias)
                {
                    <a href="/catalogo/categoria/@categoria.Id"
                       class="btn @(CategoriaId == categoria.Id ? "btn-violeta" : "btn-outline-violeta")"
                       style="@(CategoriaId == categoria.Id ? "background: linear-gradient(180deg, #450050 0%, #e753fe 100%); border: none; color: violet;" : "color: #e753fe; border-color: #e753fe; background: transparent;")">
                        @categoria.Nombre
                    </a>
                }
            }
        </div>
    </div>

    <!-- Productos -->
    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #e753fe;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" style="color: #450050;">Cargando productos...</p>
        </div>
    }
    else if (productos == null || !productos.Any())
    {
        <div class="alert text-center py-5" style="background: linear-gradient(180deg, rgba(231, 83, 254, 0.1) 0%, rgba(69, 0, 80, 0.1) 100%); border-color: #e753fe;">
            <i class="fas fa-box-open fa-4x mb-3" style="color: #e753fe;"></i>
            <h4 style="color: #450050;">No hay productos disponibles</h4>
            <p class="text-muted">No se encontraron productos en el catálogo.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var producto in productos)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                        <!-- Imagen del producto -->
                        <div class="position-relative overflow-hidden" style="height: 200px; background: linear-gradient(180deg, rgba(231, 83, 254, 0.05) 0%, rgba(69, 0, 80, 0.05) 100%);">
                            @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                            {
                                <img src="@producto.ImagenUrl"
                                     class="card-img-top h-100 w-100 p-3"
                                     style="object-fit: contain;"
                                     alt="@producto.Nombre"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200/450050/ffffff?text=Av%C3%ADtmica'">
                            }
                            else
                            {
                                <div class="h-100 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-ribbon fa-5x" style="color: #e753fe; opacity: 0.2;"></i>
                                </div>
                            }

                            <!-- Badge de stock -->
                            <div class="position-absolute top-0 end-0 m-2">
                                @if (producto.Stock > 0)
                                {
                                    <span class="badge shadow" style="background: linear-gradient(180deg, #28a745 0%, #20c997 100%);">
                                        <i class="fas fa-check-circle me-1"></i>Disponible
                                    </span>
                                }
                                else
                                {
                                    <span class="badge shadow" style="background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);">
                                        <i class="fas fa-times-circle me-1"></i>Agotado
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <!-- Nombre -->
                            <h5 class="card-title text-dark mb-2">@producto.Nombre</h5>

                            <!-- Descripción -->
                            <p class="card-text text-muted small flex-grow-1 mb-3">
                                @GetShortDescription(producto.Descripcion)
                            </p>

                            <!-- Precio -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <span class="h4 fw-bold" style="color: #450050;">$@producto.Precio.ToString("N2")</span>
                                    @if (producto.Stock > 0)
                                    {
                                        <small class="text-success d-block">
                                            <i class="fas fa-cube me-1"></i>@producto.Stock unidades
                                        </small>
                                    }
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-violeta"
                                        @onclick="() => VerDetalle(producto.Id)"
                                        style="color: #e753fe; border-color: #e753fe;">
                                    <i class="fas fa-eye me-2"></i>Ver Detalles
                                </button>

                                
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int CategoriaId { get; set; }

    private List<Producto> productos = new();
    private List<Categoria> categorias = new();
    private bool cargando = true;
    private int cantidadEnCarrito = 0;
    private int usuarioId = 1; // TODO: Cambiar por usuario real

    protected override async Task OnInitializedAsync()
    {
        await CargarCategorias();
        await CargarProductos();
        await CargarCantidadCarrito();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (CategoriaId > 0)
        {
            await CargarProductosPorCategoria();
        }
        else
        {
            await CargarProductos();
        }
    }

    private async Task CargarProductos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProductos();

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                productos = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargados {productos.Count} productos");
            }
            else
            {
                productos = new List<Producto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
            productos = new List<Producto>();
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task CargarProductosPorCategoria()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var respuesta = await ProductoService.GetProductosPorCategoria(CategoriaId);

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                productos = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargados {productos.Count} productos de categoría {CategoriaId}");
            }
            else
            {
                productos = new List<Producto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error: {ex.Message}");
            productos = new List<Producto>();
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task CargarCategorias()
    {
        try
        {
            var respuesta = await CategoriaService.GetCategorias();

            if (respuesta != null && !respuesta.Error && respuesta.Respuesta != null)
            {
                categorias = respuesta.Respuesta;
                Console.WriteLine($"✓ Cargadas {categorias.Count} categorías");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error cargando categorías: {ex.Message}");
        }
    }

    private async Task CargarCantidadCarrito()
    {
        try
        {
            // Usar el NUEVO método ObtenerItemsCarrito()
            var respuesta = await CarritoServicio.ObtenerItemsCarrito();

            if (!respuesta.Error && respuesta.Respuesta != null)
            {
                cantidadEnCarrito = respuesta.Respuesta.Sum(i => i.Cantidad);
                Console.WriteLine($"✓ Carrito: {cantidadEnCarrito} items");
            }
            else
            {
                cantidadEnCarrito = 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"✗ Error cargando carrito: {ex.Message}");
            cantidadEnCarrito = 0;
        }
        StateHasChanged();
    }

    private string GetShortDescription(string descripcion)
    {
        if (string.IsNullOrEmpty(descripcion))
            return "Producto de gimnasia rítmica de alta calidad.";

        if (descripcion.Length > 80)
            return descripcion.Substring(0, 80) + "...";

        return descripcion;
    }

    private void VerDetalle(int productoId)
    {
        Navigation.NavigateTo($"/producto/detalle/{productoId}");
    }

    /*private async Task AgregarAlCarrito(Producto producto)
    {
        Console.WriteLine($"Agregando '{producto.Nombre}' al carrito");

        try
        {
            // 1. Obtener o crear carrito activo
            var respuestaCarrito = await CarritoService.GetCarritoActivo(usuarioId);
            Carrito carrito;

            if (!respuestaCarrito.Error && respuestaCarrito.Respuesta != null)
            {
                carrito = respuestaCarrito.Respuesta;
                Console.WriteLine($"✓ Carrito activo encontrado: ID {carrito.Id}");
            }
            else
            {
                // Crear nuevo carrito
                var nuevoCarrito = new Carrito
                {
                    UsuarioId = usuarioId,
                    FechaCreacion = DateTime.Now,
                    Estado = "Activo"
                };

                var respuestaNuevo = await CarritoService.Post(nuevoCarrito);

                if (respuestaNuevo.Error)
                {
                    Console.WriteLine($"✗ Error creando carrito");
                    return;
                }

                // Obtener el carrito recién creado
                var respuestaCarritoNuevo = await CarritoService.GetCarritoActivo(usuarioId);
                if (respuestaCarritoNuevo.Error || respuestaCarritoNuevo.Respuesta == null)
                {
                    Console.WriteLine($"✗ Error obteniendo carrito creado");
                    return;
                }

                carrito = respuestaCarritoNuevo.Respuesta;
                Console.WriteLine($"✓ Nuevo carrito creado: ID {carrito.Id}");
            }

            // 2. Verificar si el producto ya está en el carrito
            var respuestaExistente = await CarritoProductoService.GetByCarritoAndProducto(carrito.Id, producto.Id);

            if (!respuestaExistente.Error && respuestaExistente.Respuesta != null)
            {
                // Si ya existe, actualizar cantidad
                var itemExistente = respuestaExistente.Respuesta;
                var nuevaCantidad = itemExistente.Cantidad + 1;

                if (nuevaCantidad > producto.Stock)
                {
                    Console.WriteLine($"✗ Stock insuficiente. Solo hay {producto.Stock} unidades");
                    return;
                }

                await CarritoProductoService.ActualizarCantidad(itemExistente.Id, nuevaCantidad);
                Console.WriteLine($"✓ Cantidad actualizada: {nuevaCantidad}");
            }
            else
            {
                // 3. Crear nuevo item en el carrito
                var nuevoItem = new CarritoProducto
                {
                    CarritoId = carrito.Id,
                    ProductoId = producto.Id,
                    Cantidad = 1,
                    PrecioUnitario = producto.Precio,
                    Color = null,
                    Tamaño = null
                };

                await CarritoProductoService.Post(nuevoItem);
                Console.WriteLine($"✓ Nuevo item agregado al carrito");
            }

            // 4. Actualizar el contador y redirigir
            await CargarCantidadCarrito();
            Navigation.NavigateTo("/carrito");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error en AgregarAlCarrito: {ex.Message}");
            Console.WriteLine($"❌ StackTrace: {ex.StackTrace}");
        }
    }*/
}